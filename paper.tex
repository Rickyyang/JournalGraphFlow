%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%2345678901234567890123456789012345678901234567890123456789012345678901234567890
%        1         2         3         4         5         6         7         8
%\documentclass[journal]{IEEEtran}  % Comment this line out
\documentclass[10pt,twocolumn,twoside]{IEEEtran} 
\IEEEoverridecommandlockouts                       % This command is only
% needed if you want to
% use the \thanks command
% See the \addtolength command later in the file to balance the column lengths
% on the last page of the document

%\documentclass[journal,twoside,web]{ieeecolor}
% The following packages can be found on http:\\www.ctan.org

\input{preamble/common}
\newcommand{\rrtstar}{$\texttt{RRT}^\texttt{*}$}
\newcommand{\SubItem}[1]{
    {\setlength\itemindent{15pt} \item[-] #1}
}

\newtheorem{constraint}{ADMM constraint}
\newtheorem{example}{Example}

\usepackage[export]{adjustbox} 
\usepackage[capitalise]{cleveref}
\usepackage{xcolor}
\newcommand{\new}[1]{\textcolor{blue}{#1}}
\newcommand{\news}{\color{blue}}
\graphicspath{{Figs/}}

\pagenumbering{arabic}

\DeclareMathAlphabet{\mathcal}{OMS}{cmsy}{m}{n}
\def\sZ{\mathcal{Z}}
\title{\LARGE \bf

Enhancing Security in Multi-Robot Systems through Co-Observation Planning, Reachability Analysis, and Network Flow}

\author{Ziqi Yang, Roberto Tron \IEEEmembership{Member, IEEE} 
\thanks{This project is supported by the National Science Foundation grant "CPS: Medium: Collaborative Research: Multiagent Physical Cognition and Control Synthesis Against Cyber Attacks" (Award number 1932162).}
\thanks{Ziqi Yang is with the Department of Systems Engineering,
Boston University, Boston, MA 02215 USA (e-mail: zy259@bu.edu).
}
\thanks{Roberto Tron is with the Faculty of Mechanical Engineering and Systems Engineering, Boston University, Boston, MA 02215 USA (e-mail:
tron@bu.edu).}}

\begin{document}



\maketitle
\thispagestyle{empty}
\pagestyle{empty}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{abstract}
This paper addresses security challenges in multi-robot systems (MRS) where adversaries may compromise robot control, risking unauthorized access to forbidden regions. We propose a novel multi-robot optimal planning algorithm that integrates mutual observations and introduces \emph{reachability} constraints for enhanced security. This ensures that, even with adversarial movements, compromised robots cannot breach forbidden regions without missing scheduled co-observations. The reachability constraint uses ellipsoidal over-approximation for efficient intersection checking and gradient computation. To enhance system resilience and tackle feasibility challenges, we also introduce \emph{sub-teams}. These cohesive units replace individual robot assignments along each route, enabling redundant robots to deviate for co-observations across different trajectories, securing multiple sub-teams without requiring modifications. We formulate the \emph{cross-trajectory co-observation} plan by solving a network flow coverage problem on the checkpoint graph generated from the original unsecured MRS trajectories, providing the same security guarantees against plan-deviation attacks. We demonstrate the effectiveness and robustness of our proposed algorithm, which significantly strengthens the security of multi-robot systems in the face of adversarial threats.
\end{abstract}
\begin{IEEEkeywords}
  Multi-robot system, cyber-physical attack, trajectory optimization, reachability analysis, network flow
\end{IEEEkeywords}


\section{Introduction}\label{sec:introduction}
Multi-robot systems (MRS) have found wide applications in various fields. While offering numerous advantages, the distributed nature and dependence on network communication render the MRS vulnerable to cyber threats, such as unauthorized access, malicious attacks, and data manipulation \cite{brunner2010infiltrating}. This paper addresses a specific scenario in which  robots are compromised by attacker and directed to \emph{forbidden regions}, which may contain security-sensitive equipment or human workers. Such countering deliberate deviations, termed \emph{plan-deviation attacks}, are identified and addressed in previous studies \cite{wardega2019resilience, wardega2023byzantine, wardega2023hola, yang2021multi, yang2020multi}. As a security measure, we utilized onboard sensing capabilities of the robots to perform inter-robot co-observations and check for unusual behavior. These mutual observation establish a co-observation schedule alongside the path, ensuring that any attempts by a compromised robot to violate safety constraints (such as transgressing forbidden regions) would break the observation plan and be promptly detected.

A preliminary version of the paper was presented in \cite{yang2020multi,yang2021multi}. Extending the grid-world solution from \cite{wardega2019resilience} to continuous configuration spaces, we incorporate the co-observation planning as constraints in \new{the alternating direction method of multipliers (ADMM)}-based trajectory optimization solver to accomodate for more flexible objectives. In this paper, we incorporate additional reachability analysis during the planning phase, incorporating constraints based on sets of locations that agents could potentially reach, referred to as \emph{reachability regions}, as a novel perspective to the existing literature. This approach enforces an empty intersection between forbidden regions and the reachability region during trajectory optimization, preventing undetected attacks if an adversary gains control of the robots. We utilize an ellipsoidal boundary to constrain the search space and formulate the ellipsoid as the reachability region constraint. We present a mathematical formulation of reachability regions compatible with the solver in \cite{yang2020multi} as a spatio-temporal constraint. 

However, such plans are not guaranteed to exist, and the secured trajectory always come at the cost of overall system performance. As an extension of the previous works \cite{yang2020multi,yang2021multi}, we also address the feasibility and optimality challenges. For a MRS with unsecured optimal trajectories (without security constraints), we introduce redundant robots and formed them into \emph{sub-teams} with the original ones. These redundant robots are assigned the task of establishing additional co-observations, termed \emph{cross-trajectory co-observations}, within and across different sub-teams. The proposed algorithm focuses on the movement plans for the additional robots, distinct from those dedicated to task objectives, indicating when they should stay with their current sub-team and when they should deviate to join another. This strategy allows sub-teams to preserve the optimal unsecured trajectories (as illustrated in \cref{fig:cross-traj-comparison-set}) without requiring the entire \emph{sub-team} to maintain close proximity to other teams during co-observation events. The cross-trajectory co-observation problem is transformed as a multi-agent path finding problem on roadmap (represented as directed graph) and solved as a network flow problem \cite{yu2013multi}.

\begin{figure}
	\centering
    \subfloat[Plan-deviation attack\label{fig:example-plan-dev}]{\includegraphics[width = 0.32\linewidth]{plan-deviation}}
    \subfloat[Co-observation \label{fig:example-co-observation}]{\includegraphics[width=0.32\linewidth]{co-observ}}
    \subfloat[Cross-trajectory co-observation \label{fig:example-cross-traj}]{\includegraphics[width=0.32\linewidth]{cross-traj}}
    
    \caption{{\news \ref{fig:example-plan-dev} Attacker deviate the red robot into forbidden region.\ref{fig:example-co-observation} Red and blue robot tasked to co-observe each other during task resulting a new secured trajectory (solid lines) replacing the optimal ones (dashed line). \ref{fig:example-cross-traj} The blue team sends one robot to observe the red team (solid blue line) while having the rest of the robots following the optimal trajectory.}\label{fig:cross-traj-comparison-set}}
\end{figure}

\noindent\myparagraph{Related research} Trajectory planning problem of MRS systems remained as a subject of intense study for many decades, and optimization is a common approaches in such area. Optimization based approaches are customizable to a variable of constraints (e.g. speed limit, avoid obstacles) and task specifications (e.g. maximum surveillance coverage, minimal energy cost). In contrast to our work in \Cref{sec:ADMM-planning}, many motion planning tasks require a non-convex constraint problem formulation, most contributors focused on convex problems, and only allow for a few types of pre-specified non-convex constraints through convexification\cite{liu2014solving}\cite{VanParys2016}\cite{Schulman2014}. Several optimization techniques like mixed integer programs with quadratic terms (MIQP)~\cite{mellinger2012mixed} and ADMM~\cite{bento2013message} have been used to reduce computational complexity, and to incorporate more complex non-convex constraints.

Graph-based search is another extensively explored approach in trajectory planning problems, such as formation control \cite{tanner2004leader,hu2019distributed} and Multi-Agent Path Finding (MAPF) problems \cite{stern2019multi}. In traditional MAPF formulations, environments are abstracted as graphs, with nodes representing positions and edges denoting possible transitions between positions and solved as a network flow problem \cite{yu2013multi,yu2016optimal}. This formulation allows for the application of combinatorial network flow algorithms and linear program techniques, offering efficient and more flexible solutions to the planning problem. %In contrast with such approach, our research in \Cref{sec:cross-trajectory} abstracts the existing Multi-Robot System (MRS) trajectory (instead of the environment) into a directed graph and formulates the cross-trajectory co-observation paths as flows.
% \rtron{Cite the paper from the reviewer, as well as the paper from Tedrake on the IRIS decomposition, saying that ellipsoids have been used to create approximations of the free configuration space, not to bound reacheability, and not for security application here.}

% Reachability analysis is a important step in the security and safety verification synthesis for cyber-physical systems (CPSs) \cite{gueguen2009safety,ding2020secure}. One typical approach involves computing an over-approximation of the reachable space for checking safety properities. Previous studies \cite{kurzhanski2000ellipsoidal,lakhal2019interval,maiga2015comprehensive} often use geometric representation, such as zonotopes and ellipsoids, as a compact enclosure of the reachability sets. In the realm of online safety assessment against cyber attacks, \cite{kwon2017reachability} computed the reachable set of CPS states achievable by potential cyber attacks and compared it with the safe region, set based on current state estimation and environmental conditions. 
\new{Reachability analysis is essential for security and safety verification in cyber-physical systems (CPSs) \cite{gueguen2009safety, ding2020secure}, often involving an over-approximation of reachable space to verify safety properties. Geometric methods like zonotopes and ellipsoids are commonly used to compactly enclose reachability sets \cite{kurzhanski2000ellipsoidal, lakhal2019interval, maiga2015comprehensive}. For online safety assessments against cyber attacks, \cite{kwon2017reachability} computed reachable CPS states under attacks and compared them with a safe region based on state estimation. By incorporating an additional security measure that provides two secured states, the reachability region in our work is over-approximated using ellipsoids. This is inspired by the ellipsoidal \emph{heuristic sampling domain} in \cite{gammell2014informed} for the $\mathtt{RRT^*}$ algorithm to simplify the sampling region between start and goal locations. Ellipsoids are also used in other path planning methods like Iterative Regional Inflation by Semidefinite programming (IRIS) \cite{deits2015computing, ray2022free} and the Safe Flight Corridor (SFC) \cite{liu2017planning, fan2024flying}. Differs from reachability region that requires mapping all reachable states given several known states, the ellipsoids of IRIS and SFC focus on approximate the safe collision-free space rather than addressing security applications.}

\noindent\myparagraph{Paper contributions} 
Two main contributions have been presented. 
\begin{itemize}
  \item We present an innovative method to integrate reachability analysis into the ADMM-based optimal trajectory solver for multi-robot systems, preventing attackers from executing undetected attacks by simultaneously entering forbidden regions and adhering to co-observation schedules.
  \item We introduce additional robots to form \emph{sub-teams} for both intra-sub-team and cross-sub-team co-observations. A new co-observation planning algorithm is formulated that can generate a resilient multi-robot trajectory with a co-observation plan that still preserve the optimal performance against arbitrary tasks. We also find the minimum redundant robots required for the security.
\end{itemize}

The rest of this paper is organized as follows. \Cref{sec:ADMM-planning} introduces the ADMM-based optimal trajectory solver and introduce the security constraints. \Cref{sec:cross-trajectory} introduces the enhanced security planning algorithm through cross-trajectory co-observation. \Cref{sec:summary} concludes this article.

\noindent\myparagraph{Notation} 
In this paper, we use non-bold symbols like to denote single-agent states (e.g. $q_{ij}$) and scalers, while bold symbols represent aggregated states involving single robot or multiple robots (e.g. $\vq$). 

\section{Secured Multi-robot trajectory planning}\label{sec:ADMM-planning}
We formulate the planning problem as an optimal trajectory optimization problem to minimize arbitrary smooth objective functions. {\news We denote the trajectory as $\vq_i = [q_{i0}\dots q_{iT}]\in\real{m\times T}$ where $q_{ij}\in\real{m}$ is the waypoint of agent $i$ in a $m$ dimensional state space and $T$ is the time horizon. For a total of $n_p$ robots, trajectories can be represented as an aggregated vector $\vq = \stack(\vq_1,\dots,\vq_{n_p})\in \real{m n_p\times T}$, where $\stack(\cdot)$ denotes the vertical stacking operation. }
\new{The overall goal is to minimize or maximize an objective function $\varPhi(\vq):\real{n m T} \to \real{}$ under a set of nonlinear constraints described by a set $\Omega$, which is given by the intersection of spatio-temporal sets given by traditional path planning constraintsand the security constraints (co-observation schedule, reachability analysis).} Formally:
\begin{equation}\label{eq:general-problem}
	\begin{split}
		\min/\max & \quad \varPhi(\vq)\\
		\textrm{subject to} &\quad \vq \in \Omega.
	\end{split}
\end{equation}

To give a concrete example of the cost $\varPhi$ and the set $\Omega$, we introduce a representative application that will be used for all the simulations throughout the paper.

\begin{example}\label{example:map_exploration}
\new{Robots are tasked to navigate an unknown task space, collecting sensory data to reconstruct a field (see~\Cref{fig:illustration}). The space is modeled as grid points, each with an associated value. The goal is to find paths that minimize uncertainty in reconstructing the field. Each grid point $j$ is associated with a Kalman Filter (KF) \cite{anderson2012optimal} to track uncertainty through its covariance $P_j$, updated based on measurements taken by robots along the trajectory $\vq$, where measurement quality, modeled by a Gaussian radial basis function, is higher near the robot. The optimization objective $\varPhi(\vq)=\max_j P_j(\vq)$ is to minimize the maximum uncertainty (detailed in \cite{yang2020multi}).}

% Robots are tasked to navigate, collecting sensory data of an unknown task space to map a slowly-varying field, denoted as $\vx$, (see Figure~\ref{fig:SecurityBreak}). The map comprises points of interest arranged on a grid, each associated with a slowly-changing value. Our goal is to find paths that minimize uncertainty and effectively reconstruct the field. We associate a Kalman Filter (KF)~(cf. \cite{anderson2012optimal}) to each point $j$, and use it to track the uncertainty through its estimated covariance $P_j$. The updates of the filters are based on measurements from the robot centered at $q$, and we use a Gaussian radial basis function  modeling spatially-varying measurement quality. The optimization objective $\varPhi(\vq)$ is written as the maximum uncertainty $\max_j P_{j}$ (detailed formulation can be found in \cite{yang2020multi}).
\end{example}
\begin{figure}
  \centering
  \subfloat[\new{Map exploration task.}\label{fig:illustration}]{\includegraphics[width = 0.45\linewidth]{illustration figure_1}} 
  \subfloat[\new{Grid world result.}\label{fig:Grid-example-application}]{\includegraphics[width = 0.45\linewidth]{Grid_world}}
  \caption{\new{(a) Grid world example of a task planned in a $8 \times 8$ grid world. Blue grids are obstacles, orange and green grids are forbidden regions.}}
\end{figure}

% \begin{definition}\label{def:secured-plan}
%   A multi-robot trajectory plan is secure again plan-deviation attacks if it ensures that any potential deviations to these forbidden regions will cause the corresponding robot to miss their next co-observation with other robots. 
% \end{definition}

To incorporate the security against malicious deviations (through co-observation and reachability analysis) as constraints in the optimal trajectory planning problem, we define the security as:
\begin{definition}\label{def:secured-plan}
  A multi-robot trajectory plan is \new{secured against} plan-deviation attacks if it \new{ensures} that any potential deviations to these forbidden regions will cause the corresponding robot to miss their next co-observation with other robots. 
\end{definition}

\subsection{Preliminaries}
\subsubsection{Differentials}
\new{We define the differential of a map $f(x):\real{d_1}\to\real{d_2}$ at a point $x_0$ as the unique matrix $\partial_x f \in\real{d_1\times d_2}$ such that}
\begin{equation}\label{equ:dt_to_dx}
  \left.\dert f\bigl(x(t)\bigr)\right|_{t=0}=\partial_x f\bigl(x(0)\bigr) \dot{x}(0)
\end{equation}
where $t\mapsto x(t)\in\real{d_1}$ is a smooth parametric curve such that $x(0)=x$ with any arbitrary tangent $\dot{x}(0)$. For brevity we will use $\dot f$ for $\dert f$ and $\partial_x f$ for $\frac{\partial f}{\partial x}$. 
%The differentials $\partial_x f$ is derived through \eqref{equ:dt_to_dx} having $\dot f$ divided by $\dot x$.

\new{With a slight abuse of notation, we use the same notation $\partial_xf$ for the differential of a matrix-valued function with scalar arguments $f:\real{d_1 \times d_3}\to\real{d_2}$.  Note that in this case \eqref{equ:dt_to_dx} is still formally correct, although the RHS needs to be interpreted as applying $\partial_x f$ as a linear operator to $\dot{x}$.}

\subsubsection{Alternating Directions Method of Multipliers (ADMM)}\label{chapter:ADMM review}
The basic idea of the ADMM-based solver introduced in \cite{yang2020multi} is to separate the constraints from the objective function using a different set of variables $\vz$, and then solve separately in \eqref{eq:general-problem}.
More specifically, we rewrite the constraint $\vq\in\varOmega$ using an indicator function $\varTheta$, and include it in the objective function (details can be found in \cite{yang2020multi}). 
%In the traditional application of ADMM, the variables $\vz$ are simple duplicates of $\vx$ projected to the constraint set $\Omega$. However, in path planning problems, some constraints are non-convex, rendering the projection step more difficult (due to the presence of multiple local minima).
We allow $\vz = D(\vq)$ to replicate an arbitrary function of the main variables $\vq$ (instead of being an exact copy in general ADMM formulation), to transform constraint $\vq\in\Omega$ to $D(\vq) \in \sZ$ to allow for an easier projection step in \Cref{eq:z-update}. In summary, we transform \Cref{eq:general-problem} into
\begin{equation}\label{eq:ADMMSetConstraint_modified}
	\begin{aligned}
		&\max\quad \varPhi(\vq)+\varTheta(\vz) \\
		& \begin{array}{r@{\quad}c}
			s.t.& D(\vq)-\vz=0
		\end{array} 
	\end{aligned}
\end{equation}
where $D(\vq)= [D_1(\vq)^T,\dots,D_l(\vq)^T]^T$ is a vertical concatenation of different functions for different constraints. This makes each constraint set $\mathcal{Z}_i$ independent and thus can be computed separately in later updating steps. $D_i(\vq)$ is chosen that the new constraint set~$\cZ_i$ becomes simple to compute which is illustrated in later secitons. % and the function~$D_i(\vq)$ can be used to select only the subset of the variables on which a constraint depends, speeding up computations.

The update steps of the algorithm are then derived as \cite{Boyd2011}:
\begin{subequations}\label{eq:ADMMupdate}
	\begin{align}
		\vq^{k+1}&:=\argmin_\vq(\varPhi(\vq^k) +\frac{\rho}{2}\norm{D(\vq)-\vz^k+\vu^k}_2^2),\label{eq:admm-mod-update-q}\\
		\vz^{k+1}&:=\Pi_\mathcal{Z}(D(\vq^{k+1})+\vu^k), \label{eq:z-update} \\
		\vu^{k+1}&:=\vu^k+D(\vq^{k+1})-\vz^{k+1}, \label{eq:u-update}
	\end{align}
\end{subequations}
where $\Pi_\mathcal{Z}$ is the new projection function to the modified constraint set $\mathcal{Z}$, $\vu$ represents a scaled dual variable that, intuitively, accumulates the sum of primal residuals
\begin{equation}\label{eq:primal-residual}
	\vr^{k}=D(\vq^{k+1})-\vz^{k+1}.
\end{equation}
Checking the primal residuals alongside with the dual residuals 
\begin{equation}\label{eq:dual-residual}
	\vs^{k}=-\rho(\vz^{k}-\vz^{k-1})
\end{equation}
after each iteration, the steps are reiterated until convergence when the primal and dual residuals are small, or divergence when primal and dual residual remains large after a fixed number of iterations.
{\news
\begin{remark}
In practical application, \eqref{eq:admm-mod-update-q} is solved iteratively via nonlinear optimization solver like \emph{fmincon}, while \eqref{eq:z-update} and~\eqref{eq:u-update} have closed form solution.
\end{remark}
}
% \rtron{Maybe state here that (9a) is solved iteratively, while (9b) and (9c) are closed-form.}

We now provide the functions $D(\vq)$, the sets $\cZ$, and the corresponding projection operators $\Pi_\cZ$ for security constraints including co-observation security constraints (\Cref{sec:co-observation-constraint}), and reachability constraints (\Cref{sec:ellipsoid-point}-\Cref{eq:region_ellipsoid_constraint}). The latter are based on the definition of \emph{ellipse-region-constraint} (\Cref{sec:reachability}).
Formulation of traditional path planning constraints like velocity constraints, convex obstacle constraints can be found in \cite{yang2020multi}, thus are omitted in this paper.

% \subsection{Velocity constraints}\label{sec:velocity-constraint}
% We constraint for the movement of each agent by a maximum velocity defined as the distance in any direction over a single discrete time step. The function $D(\vq)$ returns the velocity vectors for the $i$-th agent at each time step $j$, and constrain its result to a sphere.
% \begin{constraint}[Velocity constraint]
% \begin{align}
%      D_{ij}(\vq) &= q_{ij}-q_{i(j-1)}, \quad j\in\{1,\ldots, T\},\\
% \label{eq:velocity_constraint}
%    \sZ_{ij} &=\bigl\{\vz \mid \norm{\vz} \leq v_{max}\bigr\},\\
%    \Pi_{\sZ_{ij}}(\vz)&=\begin{cases}
%    v_{\max}\frac{\vz}{\norm{\vz}} \textrm{ if } \norm{\vz}>v_{\max},\\
%    \vz\textrm{ otherwise.}
%    \end{cases}
% \end{align}
% \end{constraint}

% \subsection{Convex polygonal obstacles collision constraints} \label{sec:obstacle-constraint}
% We use convex polygons $\cP$ to model regions  that cannot be entered by agents (solid obstacles and forbidden regions). $\cP$ is defined using a collection of $l$ hyperplanes $n_{k}\transpose q = m_{k}$, where $n_k$ is the normal vector pointing toward the outside of the obstacle and $m_k$ is the scalar offset defining the $k$-th hyperplane.We define the function $D(\vq)$ to return the maximum distance from $q_{ij}$ to all hyperplane boundaries of region $\cP$, and  constraint $z$ to be a non-negative scalar. This constraint is applied to all $q_{ij} \in \vq$. 

% Non-convex obstacles can be handled by a union of (possibly overlapping) convex obstacles. And by using outward-pointing normals for $n_k$, this method can also serve to constrain the robots within a designated workspace region.
% \begin{constraint}[Obstacle constraint]
% \begin{align}
%      	D(q_{ij}) &= \max_{k=1,\dots,l} (d_{k}(q_{ij},\cP)),\\
% \label{eq:obstacle_constraint}
%   \sZ &= \{z \mid z \geq 0 \},\\
%    \Pi_\sZ(z) & = \begin{cases}
%    0 & \textrm{if} \quad z < 0,\\
%    z  & \textrm{otherwise.}
%    \end{cases} \label{eq:zoneConstraintProjection}
% \end{align}
% where $d_{k}(q_{ij},\cP)= p_{ij}\transpose n_k - m_k$ returns the distance between a single waypoint $q_{ij}$ and the $k$th hyperplane .
% \end{constraint}
% %The motivating idea for \eqref{eq:obstacle_constraint} and \eqref{eq:zoneConstraintProjection} is to identify waypoints within a specific region and project them to the closest boundary. 

% \subsection{Waypoints with flexible deadlines}\label{sec:waypoint-constraint}
% Security-related constraints often necessitate that a robot reaches a specified location at a particular time. We assume that robot $i$ is tasked with reaching a given point $p$ within a radius of $d_{max}$ at some time instant $j$ within a predefined time window $[t_1,t_2]$, leading to the following:

% \begin{constraint}[Waypoint constraint]
% \begin{align}
%      	D(\vq) &= \min_{j\in\{t_1,\dots,t_2-1\}}\bigl(\dist(p,\overrightarrow{q_{ij}q_{i(j+1)}})\bigr),\\
% \label{eq:waypoint_constraint}
%   \sZ &= \{z \mid z < z_{max} \},\\
%    \Pi_\sZ(z) & = \min(z, d_{max}),
% \end{align}
% where $\dist(p,\overrightarrow{q_{ij}q_{i(j+1)}})$ returns the distance between the fixed point $p$ and the segment $\overrightarrow{q_{ij}q_{i(j+1)}}$.
% \end{constraint}

% This function returns the smallest distance between $(p,q_{ij})$ and $(p,q_{i(j+1)})$ if the projection of the point $p$ does not lie on the line segment~$\overrightarrow{q_{ij}q_{i(j+1)}}$; as a consequence, this constraint does not need to be satisfied exactly at one of the points on the discretized trajectory, but it can also be satisfied ``en route'' on the segment between them.

\subsection{Co-observation schedule constraint}\label{sec:co-observation-constraint}
The co-observation constraint ensures that two robots come into close proximity at scheduled times to observe each other's behavior. This constraint is represented as a relative distance requirement between the two robots at a specific time instant, ensuring they are within a defined radius to inspect each other or exchange data. %Importantly, the co-observation locations must be chosen to guarantee that the ellipsoidal reachability regions, as discussed in \Cref{sec:reachability}, do not intersect with any forbidden regions.

%The co-observation constraints is used to guarantee that, at time required by the schedule, two robots should get close enough with each other to observe each other's behavior. This constraint is modeled as a relative distance constraint between two robots at some time instant $j$ (i.e., to require two agents see each other within a certain radius to inspect each other, or to exchange data). The location of the co-observation should make sure that the ellipsoidal reachability region between each co-observation, considered in later sections \ref{sec:reachability}, has an empty intersection with all forbidden regions.

% We write the function for the constraint as:
\begin{constraint}[Co-observation constraint]\label{constraint:coobservation}
\begin{align}
D(\vq) &= \overrightarrow{q_{aj}q_{bj}}, \label{eq:coobservation_constraint}\\
  \sZ &= \{\vz \mid \norm{\vz} \leq d_{max} \},\\
   \Pi_\sZ(z) & = \begin{cases}
d_{max}\frac{\vz}{\norm{\vz}} &\text{if } \norm{\vz} > d_{max},\\
\vz	& otherwise,
\end{cases}
\end{align}
where $a,b$ are the indices of the pair of agents required for a mutual inspection, \new{$d_{max}$ is the maximum distance between a pair of robots that the secure can be ensured through co-observation.}
\end{constraint}
The locations $q_{aj}$ and $q_{bj}$ where the co-observation is performed are computed as part of the optimization.

\subsection{Definition of ellipsoidal reachability regions}\label{sec:reachability}

\new{In this section, we define \emph{ellipsoidal reachability regions} with respect to a pair of locations along a trajectory. We then use the ellipsoids to introduce various reachability constraints with respect to other geometric entities, such as points, lines, line segments, and polygons. These constraints, combined with the co-observation constraint~\ref{constraint:coobservation}, form the basis of the secured ADMM planning presented in \cref{chapter:ADMM review}.
}
% In this section, we define \emph{ellipsoidal reachability regions} based on pairs of co-observation locations on a trajectory, and a transformation of such region in axis-aligned form. Different types of reachability constraints (between an ellipsoid and different geometric entities such as a point, line, line segment, and polygon) alongside their projections, and differentials are introduced in subsequent sections. Together with the co-observation constraint~\ref{constraint:coobservation}, these will be used in the ADMM formulation of \cref{chapter:ADMM review} to provide security for all observed and unobservered periods.
%The reachability region is defined as the set of locations $q(t)$ that a robot can reach between two given fixed positions:
{\news
\begin{definition}\label{sec:ellipsoidal definition}
Consider a robot $i$ starting from $q_{1}$ at time $t_1$ and reaching $q_{2}$ at time $t_2$. The \emph{reachability region} between $t_1$ and $t_2$ is defined as the set of points $q'$ in the free configuration space for which there exists a kinematically feasible trajectory containing $q'$.
	% The \emph{reachability region} for two waypoints $q(t_1)=q_1$, $q(t_2)=q_2$ is defined as the sets of points $q'$ in the \new{free configuration space} such that there exist a \rtronhl{this $q$ should be probably $q_{dev}$ or something similar, to distinguish it from the planned $q$}{trajectory $q(t)$ where $q(t')=q'$, $t_1\leq t' \leq t_2$ and $q(t)$ satisfies the velocity constraint $d(q(t),q(t+1))\leq v_{max}$}\rtron{, where $d(\cdot,\cdot)$ represents the distance between two points}. 
\end{definition}

For simplicity, in this paper we consider only a maximum velocity constraint $v_{max}$; the reachability region for $q'$ can then be over-approximated by the following (the over-approximation is obtained by neglecting physical obstacles):%$\mathcal{E}=\{q'\in\mathbb{R}^n: d(q_1,q')+d(q'q_2)<v_{max}(t_2-t_1)\}$, where $d(\cdot,\cdot)$ denotes the Euclidean distance between two points.
\begin{definition}\label{def:Reachability}
	The \emph{reachability ellipsoid $\cE$} is defined as the region $\mathcal{E}(q_1,q_2,t_{1},t_{2})=\{\tilde{q}\in\mathbb{R}^n: d(q_1,\tilde{q})+d(\tilde{q},q_2)<2a\}$, where $a=\frac{v_{max}}{2}(t_2-t_1)$.
\end{definition}
This region is an ellipsoid because it represents the set of points $q'$ whose sum of distances two \emph{foci} $q_1$ and $q_2$ is less then $2a$, where a is the major radius of the ellipsoid. }
 \begin{figure}
    \centering
    \subfloat[Showcase of a reachability region\label{fig:EllipseConstraintExample}]{\includegraphics[width=0.47\linewidth, trim = 2cm 2.5cm 2cm 5cm]{Reachability}}
    \subfloat[Point-ellipsoid constraint \label{fig:Ellipse-to-point}]{\includegraphics[width=0.47\linewidth, trim = 0.3cm 1.3cm 0.3cm 1.3cm, clip]{Ellipse2point}}

    \subfloat[Plane-ellipse constraint \label{fig:Ellipse-to-plane}]{ \includegraphics[width=0.47\linewidth, trim = 0.3cm 1cm 0.3cm 1cm, clip]{Ellipse2line_V2}}
    \subfloat[Polygon-ellipse constraint \label{fig:Ellipse-to-safezone}]{\includegraphics[width=0.47\linewidth,trim = 0cm 1cm 0.3cm 0.5cm, clip]{Ellipse2safezone_V2}}

    \caption{\news (\ref{fig:EllipseConstraintExample}) Black line is the planned trajectory, $q_1$ and $q_2$ are two co-observed locations the robot are expected at given time $t_1$ and $t_2$, dashed lines show possible trajectory of a compromised robot during unobserved period. Axis of global frame $\cF$ and canonical frame $\cF_{\cE}$ are shown as $x_{\cF}, y_{\cF}$ and $x_{\cE}, y_{\cE}$ respectively. 
    (\ref{fig:Ellipse-to-point}) For point-ellipsoid constraint, $q_{avoid}$ is projected to the areas outside the ellipsoid to $q_{p}$. 
    (\ref{fig:Ellipse-to-plane}) For plane-ellipsoid constraint, the projection is simplified to the point-ellipse constraint that projecting point $p_{L}$ outside the ellipse to $p_{t}$.
    (\ref{fig:Ellipse-to-safezone}) For convec-polygon-ellipsoid constraint, the projection either a plane-ellipse constraint $D_{1}$ (for red region) or a point-ellipse constraint $D_{2}$ (for brown region).}
    \label{fig:Reachability_full}
  \end{figure}

{\news The condition that a reachability ellipsoid $\cE(q_1,q_2)$ does not intersect with any forbidden region is sufficient to secure the trajectory of the robot between $q_1$ and $q_2$ according to \Cref{def:secured-plan}: any deviation to a point $p_o$ outside $\cE(q_1,q_2)$ will cause the robot to miss a potentia observation at $p_2$, $t_2$. \Cref{def:secured-plan} can then be restated as follows:
\begin{definition}\label{rmk:revised-security}
  A multi-robot trajectory is secured against plan-deviation attacks if there exist a co-observation plan such that the reachability region between each consecutive co-observation does not intersect with any forbidden regions.
\end{definition}
}

\subsection{Transformation to canonical coordinates}\label{sec:rotation2Standard}
\newcommand{\oFE}{o}
{\news To use the definition of reachability ellipsoid from the section above in a computational constraints for ADMM, we first apply a differentiable rigid body transformation to reposition the ellipse $\cE$ from the global frame $\cF$ to a canonical frame $\cF_\cE$, where the origin of $\cF_\cE$ is at the ellipsoid's center $\oFE = \frac{1}{2}(q_1+q_2)$, and the first axis of $\cF_\cE$ is aligned with the foci (see \Cref{fig:EllipseConstraintExample} for an illustration). 
From this definition, a unit vector along the first axis of the ellipsoid in the frames $\cF$ and $\cF_\cE$ is given by $\nu_\cF = \frac{q_2-q_1}{\norm{q_2-q_1}}$ and $\nu_\cE =[1,0,0]^T$, respectively.
The full transformation from coordinates $q^\cE\in\cF$ to $q\in\cF$, and its inverse, are then parametrized by a rotation $R^\cF_\cE$ and a translation $o^\cF_\cE$ as (we drop the subscript and superscript from $R^\cF_\cE$ and $o^\cF_\cE$ to simplify the notation):
\begin{equation}\label{eq:transformations}
  q=R\Eframe{q}+\oFE,\quad
  \Eframe{q}=R\transpose(q-\oFE).
\end{equation}
where the rotation matrix $R=H(\nu_\cF(q_1,q_2),\nu_\cE)$ is a \emph{Householder rotation} $H$ (a differentiable linear transformation describing the minimal rotation between the two vectors, see \cref{sec:householder} for details).  To simplify the notation, in the following, we will consider $H$ to be a function of $q_1,q_2$ directly, i.e. $H(q_1,q_2)$. More details on \eqref{eq:transformations} are given in \cref{apx:transformation}.
  % We define $\nu_\cF$ and $\nu_\cE$ to represent the $x$-axis unitary vector of $\cF_\cE$ in the frames $\cF$ and $\cF_\cE$, respectively. Formally:
  % \begin{align}
  %   \nu_\cF &= \frac{q_2-q_1}{\norm{q_2-q_1}}, & \nu_\cE&=[1,0,0]^T;
  % \end{align}
  % \new{see Fig.\ref{fig:EllipseConstraintExample} for an illustration. Note that $\nu_{\cF}$ is a function of $q_1,q_2$ while $\nu_\cE$ is constant. From the definition of $\cF_\cE$, the rotation $R$ can be found using a \emph{Householder rotation} (see \cref{sec:householder}), while from \eqref{eq:transformations} the translation $o$ must be equal to the center of $\cE(q_1,q_2)$ expressed in $\cF$, i.e.:}
  % \begin{align} 
  %   R&=H(\nu_\cF(q_1,q_2),\nu_\cE), &o&=\frac{1}{2}(q_1+q_2).
  % \end{align}

  Reachability constraints are formulated with respect to different types of forbidden regions a point, a plane, a segment, and a convex polygon.}
  % We are now ready to formulate constraints based on reachability ellipsoids against different types of forbidden regions: a point, a plane, a segment, and a convex polygon which is is done by defining $D(q)$, its differential $\partial_qD(q)$, the set $\zeta$ and the projection $\Pi_\zeta$.

\subsection{Point-ellipsoid reachability constraint}\label{sec:ellipsoid-point}
% As shown in Fig.\ref{fig:Ellipse-to-point}, we consider a forbidden region in the shape of a single point $q_{avoid}$. The goal is to design the trajectory $q(t)$ such that $q_{avoid}\notin\mathcal{E}(q_1,q_2)$. This constraint can be written as, 
{\news For a forbidden region in the shape of a single point $q_{avoid}$ (\cref{fig:Ellipse-to-point}), the constraint is written as:}
\begin{constraint}[Point-ellipsoid reachability constraint]
\begin{align}
D(\vq) &=  \begin{cases}
      \pi_{p\cE}(\vq) - q_{avoid} & q_{avoid} \in \cE, \\
      {0} & \textrm{otherwise}.
    \end{cases} \label{eq:point_ellipsoid_constraint}\\
  \sZ &= \{q\in\mathbb{R}^{nm}:\norm{D_p(\vq)} = 0 \},\\
   \Pi_\sZ(\vz) & = 0, 
\end{align}
\end{constraint}

where $\pi_{p\cE}(q_{avoid};q_1,q_2,a) = q_p$ is a projection function that returns a projected point $q_p$ of $q_{avoid}$ outside the ellipse, i.e., as the solution to
\begin{equation}\label{eq:ellipse-point-projection}
\pi_{p\cE}=\argmin_{q_p\in\cE^c} \quad \norm{q_{avoid}-q_p}^2 
\end{equation}
where $\cE^{c}$ is the set complement of region $\cE$.

For cases where $q_{avoid} \notin \cE(q(t_2),q(t_1),r)$, $\pi_{p\cE}(q_{avoid}) = q_{avoid}$. And for cases where $q_{avoid} \in \cE(q_1,q_2,r)$, $D(q)$ needs to be projected to the boundary of the ellipse. 
In the canonical frame $\cF_{\cE}$, the projected point $q^{\cE}_{p}$ can be written as:
  \begin{equation}
  	q^\cE_{p} = {(I+sQ)}\inverse q^\cE_{avoid} = S q^\cE_{avoid}
  \end{equation}
  %where $S=(I+sQ)\inverse$.Using the fact that since $q^\cE_p$ is a point on the ellipse, 
where $s$ can be solved as the root of the level set \eqref{equ:standard-ellipse}:
  \begin{equation}
    {q^\cE_p}\transpose Q q^\cE_p-1={q^\cE_{avoid}}\transpose Q'(s) q^\cE_{avoid} -1=0
  \end{equation}
  where
  \begin{equation}
    Q'(s) =S\transpose Q S = \diag\left(\frac{a^{2}}{(s+a^{2})^2}, \frac{b^{2}}{(s+b^{2})^2},\frac{b^{2}}{(s+b^{2})^2}\right)
  \end{equation}
 Detailed methods for computing $s$ can be found in \cite{yang2021multi,yang2020multi,eberly}. 


  %The point to project, $q_{avoid}$, can be likewise expressed in $\cF_\cE$ as $\Eframe{q}_{avoid} =  H (\Fframe q_{avoid}-o)$. We now turn our attention to the problem of projecting $\Eframe{q}_{avoid}$ on the zero level set of $E^\cE$ (i.e., the reachability ellipsoid in the canonical frame). The derivations below are loosely inspired by \cite{eberly}.

  %Let $q^\cE_p$ be the point on the surface of the ellipsoid, i.e., $\Eframe E(q^\cE_p) = 0$, corresponding to the projection of the point $q^\cE_{avoid}$. Using Lagrange multipliers applied to the constrained optimization problem \eqref{eq:ellipse-point-projection} (after transforming it in the canonical frame), one can show that the vector from a point to its projection, $q^\cE_{avoid}- q^\cE_p$, must be collinear with the gradient of $\Eframe \cE$, i.e.
 % \begin{equation}
 %   q^\cE_p- q^\cE_{avoid} = s \partial_q \Eframe E(q^\cE_p)\transpose = s Q q^\cE_p
  %\end{equation}
  %for some scale $s\in\real{}$;
 % thus $q^\cE_p$ can be written as:

The point-to-ellipse projection function in $\cF$ is then:
  \begin{multline}\label{equ:Point2EllipseProjection}
    \pi_{p\cE}(q)= R^{-1}(q(t_1),q(t_2))q^\cE_p+o \\
    = R^{-1}(q(t_1),q(t_2))Sq^\cE_{avoid}+o\\
    = R^{-1}S R ( q_{avoid}- o)+o
  \end{multline}
  
In our derivations, we consider only the 3-D case ($m=3$); for the 2-D case, let $P=\bmat{I & 0}\in\real{2\times 3}$: then $\pi_{p\cE}^{\textrm{2D}}=P\pi_{p\cE}^{\textrm{3D}}(P\transpose q_{avoid}; P\transpose q_1, P\transpose q_2,a)$.

  \begin{proposition}\label{prop:Ellipse2PointDiff}
    The differential of the projection operator $\pi_{p\cE}(q_{avoid}; q_1,q_2,a)$ with respect to the foci $q_1,q_2$ is given by the following (using $q$ as a shorthand notation for $q^\cE_{avoid}$)
    \begin{multline}
      \partial_{\left[\begin{smallmatrix}q_1\\q_2\end{smallmatrix}\right]} \pi_{p\cE}=-2 H [ SH(q-o)]_{\times}U   \\
      + \left( (q\transpose \partial_sQ' q)^{-1} H^{-1} Q' q q\transpose  (4Q' H[q - o]_\times U \right. \\
      \left.+ 2Q' H\partial_q o - \partial_b Q' q q \partial_q b) -  s H^{-1} S^2 \partial_b Q q \partial_q b\right) \\
      -2H^{-1} S H[q-o]_{\times} U  + (H^{-1}SH -I)\partial_q o
    \end{multline}
  \end{proposition}
  \begin{proof}
  See \Cref{proof:Ellipse2PointDiff}.
  \end{proof}
  The differential of $D_p$ is the same as the one for $\pi_{p\cE}$.

\subsection{Plane-ellipsoid reachability constraint}\label{sec:ellipsoide-plane}

\new{For a hyperplane shaped forbidden region $\mathcal{L}(q) = \{q\in\mathbb{R}^m: \vn\transpose q = d\}$ (\cref{fig:Ellipse-to-plane}), the reachability constraint is $\mathcal{L} \cap \mathcal{E}(q_1,q_2,a) = \emptyset$. When transformed into the canonical frame, the hyperplane can be written as $\Eframe \cL(\Eframe{q}) = \{  \Eframe{q}\in\mathbb{R}^m:  \vn_\cE\transpose \Eframe{q} = d_{\cE}\}$, with $\vn_\cE = H(q_1,q_2)\vn, \quad d_\cE =-\vn\transpose o + d$.}
% Intuitively, $d_\cE$ can be thought as a distance between the the plane $\cL$ and the origin (i.e., the center of $\cE$).

For every $\Eframe \cL(\Eframe{q})$, there exist two planes that are both parallel to $\cL$ and tangential to the ellipse (i.e. resulting in a unique intersection point \cref{fig:Ellipse-to-plane}), $\cL_1^{\cE} = \{\Eframe{q}\in\mathbb{R}^m: \vn_\cE \transpose \Eframe{q} =  d_{\cE t} \}$ and $\cL_2^{\cE} = \{\Eframe{q}\in\mathbb{R}^m: \vn_\cE \transpose \Eframe{q} = - d_{\cE t} \}$. The intersection point can be written as:
\begin{equation}
    p^\cE_{t_{1}} = \frac{ d_{\cE t} Q^{-1}   n_\cE}{ n_\cE \transpose Q^{-1}  n_\cE} = \frac{Q^{-1} n_\cE}{ d_{\cE t}},\quad  p^\cE_{t_{2}} = -  p^\cE_{t_{1}},
\end{equation}
where $d_{\cE t} = \sqrt{ n_\cE\transpose Q^{-1} n_\cE}$; intuitively, $d_{\cE t}$ can be thought as a distance between the tangent plane $\cL_1^\cE$ (or $\cL_2^\cE$) and the origin (i.e., the center of the ellipse $\cE$). The concept of \emph{tangent interpolation point}s is introduced to characterize the relationship between the plane and the ellipsoid.

\begin{definition}
 {\news The \emph{tangent interpolation point} $p^\cE_{\cL} \in \mathcal{L}$ between the plane $\cL$ and the ellipsoid $\cE$ is defined on the plane by } 
    \begin{equation}\label{equ:ProjectPoint}
      p^\cE_{\cL} = \frac{ d_\cE Q^{-1} n_\cE}{ n_\cE\transpose Q^{-1} n_\cE}.
    \end{equation}
  Intuitively, the point $p^\cE_\cL$ is the point on $\cL$ which is closest to either $p^\cE_1$ or $p^\cE_2$.
  Note that when  $d_\cE=d_{\cE t}$ or $d_\cE=-d_{\cE t}$, $p^\cE_{\cL}=p^\cE_{t_1}$ or $p^\cE_{\cL}=p^\cE_{t_2}$, respectively. When $ d_\cE \in [- d_{\cE t},  d_{\cE t}]$, the plane $\cL$ and the ellipsoid $\cE$ have at least one intersection, thus violating our desired reachability constraint. 
\end{definition}

With these definitions, the constraint can be written as:
\begin{constraint}[Plane-ellipsoid reachability constraint]
\begin{align}
D(\vq) &= H^{-1}(q_{1},q_2)\pi^\cE_{\vn_\cE}(\vq)+o, \label{eq:plane_ellipsoid_constraint}\\
  \sZ &= \{\vq\in\mathbb{R}^{nm}:\norm{D_{\vn}(\vq)} = 0 \},\\
   \Pi_\sZ(\vz) & = \overrightarrow{0}, 
\end{align}
\end{constraint}
where $\pi^\cE_{\vn_\cE}(q)$ is the projection operator defined as:
  \begin{equation}\label{equ:plane2ellipse}
    \pi^\cE_{\vn_\cE}(\vq) =\begin{cases}
      p^\cE_{t_1}-p^\cE_{\cL} & \textrm{ if } d_\cE \in [0, d_{\cE t}], \\
      p^\cE_{t_2}-p^\cE_{\cL} &  \textrm{ if } d_\cE \in [- d_{\cE t},0), \\
      {0} & \textrm{otherwise}.
    \end{cases}
  \end{equation}

  \begin{proposition}\label{prop:dpi_ne_dt}
    The differential of the projection function $\pi^\cE_{\vn \cE}(\vq)$ with respect to the foci $q_1$ and $q_2$ is given by:
    \begin{equation}
      \partial_q \pi^\cE_{\vn \cE}(q) = \begin{cases}
        \partial_q p^\cE_{t1}-\partial_q p^\cE_{\cL} &  d_\cE \in [0, d_{\cE t}], \\
        \partial_q p^\cE_{t2}-\partial_q p^\cE_{\cL} &  d \in [- d_{\cE t},0), \\
        {0} & otherwise.
      \end{cases}
    \end{equation}
    where
    \begin{multline}
      \partial_q p_\cL =   (-\frac{d_{\cE t} n\transpose \partial_q o -2d_\cE \partial_q d_{\cE t}}{d_{\cE t}^3} )Q^{-1}n_\cE \\
      + \frac{d_\cE\partial_b Q^{-1} n_\cE \partial_q b -  2d_\cE Q^{-1}H[n]_\times U}{d_{\cE t}^2},
    \end{multline}
    \begin{equation}
      \partial_q p_{1} =  -\frac{Q^{-1}n_\cE \partial_q d_{\cE t} }{d_{\cE t}^2} 
      + \frac{\partial_b Q^{-1}n_\cE \partial_q b -  2Q^{-1}H[n]_\times U }{d_{\cE t}}.
    \end{equation}
  \end{proposition}
  \begin{proof}
  See \Cref{proof:dpi_ne_dt}.
  \end{proof}
 The differential of (\ref{eq:plane_ellipsoid_constraint}) can be written as:
  \begin{equation}
    \partial_q {D_{\vn\cE}} = -2 H \cross{\Eframe \Pi_{\vn \cE}}  M + H^{-1}\partial_q \Eframe \Pi_{\vn \cE}.
  \end{equation}
\subsection{Line-segment-ellipse reachability constraint}\label{chapter:ellipse to segment}
{\news As an intermediate step to consider polygon shaped forbidden regions, the reachability constraint for hyperplane segments is studied.
For hyperplane $\Eframe \cL(\Eframe q) = \{ \Eframe q\in\mathbb{R}^m:  \vn_\cE\transpose \Eframe q = d_{\cE}\}$ with endpoints $\Eframe {p_1}$ and $\Eframe{p_2}$; this segment is defined as:}
\begin{equation}
\bmat{(\Eframe {p_1}- \Eframe{p_2})\transpose\\( \Eframe{p_2} - \Eframe{p_1})\transpose}  \Eframe p \leq \bmat{ \Eframe{p_2}\transpose\\- \Eframe{p_1}\transpose}( \Eframe{p_1}- \Eframe{p_2}), \quad \vn_\cE\transpose \Eframe q = d_{\cE}.
\end{equation}
When the \emph{tangent interpolation point} $\Eframe{p_{\cL}}$ stays within the segment (i.e. red region in \cref{fig:Ellipse-to-safezone}), the constraint is a plane-ellipse constraint in \cref{sec:ellipsoide-plane}. Otherwise (i.e. brown region in \cref{fig:Ellipse-to-safezone}), the constraint is a point-ellipse constraint in \cref{sec:ellipsoid-point}.

\begin{constraint}[Line-segment-ellipsoid reachability constraint]
\begin{align}
D(\vq) &=  \begin{cases}
D_{p_{1}}(\vq) & (\Eframe{p_1}-\Eframe{p_2})\transpose (\Eframe{p_{\cL}}-\Eframe{p_2})<0\\
D_{p_{2}}(\vq) & (\Eframe{p_2}-\Eframe{p_1})\transpose (\Eframe{p_{\cL}} -\Eframe{p_1})<0\\
D_\Eframe{p_{\cL}}(\vq) & \textrm{otherwise}
\end{cases} \label{eq:segment_ellipsoid_constraint}\\
  \sZ &= \{\vq\in\mathbb{R}^{nm}:\norm{D(\vq)} = 0 \},\\
   \Pi_\sZ(\vz) & = 0, 
\end{align}
\end{constraint}
where $D_{p_{1}}$ and $D_{p_{2}}$ are the point-ellipsoid constraint projection function~\eqref{eq:point_ellipsoid_constraint} with respect to $\Eframe{p_{1}}$ and $\Eframe{p_{2}}$, and $D_\Eframe{p_{\cL}}$ is the plane-ellipsoid constraint~\eqref{eq:plane_ellipsoid_constraint}. with respect to frame $\Eframe {\cL}$.

\subsection{Convex-polygon-ellipse reachability constraint}\label{sec:ellipse-region-constraint} 
For reachability constraints with respect to a convex polygon, the first step is to keep all segments that defines the hyperplane outside the reachability ellipsoid. Similar to \eqref{equ:ProjectPoint}, we define
\begin{constraint}[Convex-polygon-ellipsoid reachability constraint]\label{constraint:polygon-ellipsoid}
\begin{align}
D(\vq) &= \bmat{D_{seg1}(\vq)\\D_{seg2}(\vq)\\ \vdots} \label{eq:region_ellipsoid_constraint}\\
  \sZ &= \{\vq\in\mathbb{R}^{nm}:\norm{D(\vq)} = 0 \},\\
   \Pi_\sZ(\vz) & = 0, 
\end{align}
\end{constraint}
where $D_{seg}$ are the constraint functions for all line segments used to define the convex polygon region. This constraint needs to be supplemented with a convex obstacle constraint for the polygon (i.e. keep foci waypoints outside the region, introduced in \cite{yang2020multi}) to prevent cases where the ellipse is a subset of the region.

\subsection{Secured planning results and limitation}\label{sec:ADMM-simulation}

We test the newly introduced security constraints with~\cref{example:map_exploration}, illustrated in~\cref{fig:example-application} in both simulations and on an experimental testbed, involving a 3-robot system assigned to explore a $10m\times10m$ region with one obstacle, \emph{Zone 1}, and two forbidden zones, \emph{Zone 2} and \emph{Zone 3}. The maximum velocity constraint $v_{max}=0.5m/dt$, time horizon $T=20$. %All robots are tasked with collecting sensor information on the vector field, with higher accuracy of sensor data for locations closer to the agent. %robots are expected to follow a boustrophedon pattern (similar to the unconstrained result in Figure~\ref{fig:SecurityBreak}). %We apply the new security constraints on the map exploration problem shown in \Cref{fig:example-application}, test the algorithm in both simulations and an experimental testbed. The 3-robot system is tasked to explore a $10m\times10m$ region with two forbidden regions \emph{Zone 2, 3}. The maximum velocity constraint $v_{max}$ is set to~$0.5m/dt$ a time limit of 20. 

We employ the \new{attack-proof MAPF(APMAPF)} solver \cite{wardega2019resilience} on a 8 by 8 grid world with similar setup to generate a MAPF plan with a co-observation schedule in a grid-world application (Fig.\ref{fig:Grid-example-application}). This result is transformed to a continuous configuration space and serves as the initial trajectory input for the ADMM solver with additional task function targeting the map exploration task. Co-observation schedules are set up using the APMAPF algorithm for two forbidden regions. Reachability constraints are added to ensure an empty intersection between all robots' reachability regions during co-observations and the forbidden regions. {\news It is important to emphasize that an APMAPF solution does not guarantee existence, nor does it ensure a successful transition to the continuous configuration space. In this cases, while an APMAPF solution may be found, the secured, attack-proof solution becomes infeasible in the continuous setting because the robots' mobility is no longer restricted to adjacent grids. Additional security measures, such as stationary security cameras or surveillance robots, need to be incorporated. For instance, in this scenario, we deploy a security camera as additional checkpoint to observe agent 3 at time $8$ to ensure security.}

The simulation result, shown in Fig.~\ref{fig:ReachabilitySimulation}, displays reachability regions as black ellipsoids, demonstrating empty intersections with Zones 2 and 3. Explicit constraints between reachability regions and obstacles are not activated, assuming basic obstacle avoidance capabilities in robots. The intersections between obstacles and ellipsoids, as observed between agent 3 and Zone 1, are deemed tolerable. All constraints are satisfied, and agents have effectively spread across the map for optimal exploration tasks.

%As depicted in Fig.\ref{fig:Grid-example-application}, no explicit tasks are assigned besides the start and goal locations. Agents 1 and 2 need to meet at times 8 and 14, while agents 2 and 3 need to meet at time 18. This result serves as the initial trajectory input for the ADMM solver. Considering this schedule, reachability for all agents in-between scheduled co-observations is constrained and kept away from the forbidden regions. % It's important to note that additional checkpoints (e.g., stationary security cameras) need to be incorporated to generate an attack-proof solution. Further solutions to avoid these checkpoints are discussed in \Cref{sec:cross-trajectory}.

%We utilize the APMAPF solver introduced in \cite{wardega2019resilience} to generate a MAPF plan with co-observation schedule on a grid-world application (Fig.\ref{fig:Grid-example-application}) and transform the result to a continuous configuration space, under the map exploration tasks.  All robots have the task of collecting sensor information on the underlying vector field, with agent 3 having an additional task to visit the \emph{checkpoint} at time $8$. Assuming that the sensors on the robots return data with higher accuracy for locations closer to the agent, the robots should ideally perform a boustrophedon pattern (like the unconstraint result in Figure~\ref{fig:SecurityBreak}). We first set up an co-observation schedules considering two forbidden regions using the APMAPF algorithm, and add reachability constraints ensure a empty intersection between all robots' reachability regions between co-observations and forbidden regions.

%As shown in Fig.\ref{fig:Grid-example-application}, no task has been assigned to the agent besides the start and goal location. Agent 1 and 2 need to meet at time 8 and 14, whereas agent 2 and 3 need to meet at time 18. This result is also used as the initial trajectory input for the ADMM solver. 

%Based on the schedule, reachability for agent 1 in-between the scheduled co-observations are constrained. Notice that additional checkpoint (i.e. stationary security camera) need to be incorporated in order to generated an attack-proof solution. Additional solutions to avoid these checkpoints will be discussed in \Cref{sec:cross-trajectory}.  
%The result of the simulation is shown in Fig.~\ref{fig:ReachabilitySimulation}. The reachability regions are shown as black ellipsoids, and we can show that all of them have empty intersections with Zone 2 and 3. Notice that no explicit constraints have been enabled between reachability regions and obstacles, because we assume that robots have the basic obstacle avoidance capability and can not go through any hard obstacles. Therefore, the intersections between obstacles and ellipsoids, i.e. the case here between agent 3 and zone 1, are tolerable. All constraints have been satisfied and, to the best of their capability, agents have spread out across the map to perform the best possible exploration task. 
\begin{figure}
  \centering
  % \subfloat[Grid-world trajectory. \label{fig:Grid-example-application}]{\includegraphics[width=0.45\linewidth, trim = 2cm 0.5cm 0cm 2cm]{Kacper_result}}
  \subfloat[Continuous world trajectory \label{fig:SecurityBreak}]{\includegraphics[width=0.45\linewidth, trim = 2cm 2cm 2cm 2cm]{SecurityBreak}}
  \subfloat[Securd result \label{fig:ReachabilitySimulation}]{\includegraphics[width=0.45\linewidth,trim =1cm 1.5cm 1cm 1.5cm, clip]{FinalResult}}
  \caption{Trajectory design of a map exploration task forthree-robot system based on result in grid world result~\Cref{fig:Grid-example-application}. Zone 1 is obstacle, Zone 2 and Zone 3 are safe zones. \Cref{fig:SecurityBreak} shows the unsecured trajectory design in continuous world optimized with respect to a map exploration task where Zone 1 and 2 are considered together as one obstacle.  A potential path that could break the security by entering region 1 is highlighted in dashline. \Cref{fig:ReachabilitySimulation} shows the secured trajectory with the incorporation of co-observation and reachability constraints.}
  \label{fig:example-application}
\end{figure}

% \begin{figure}
% \begin{center}
%   \includegraphics[width=0.6\linewidth,trim =1cm 1.5cm 1cm 1.5cm, clip]{FinalResult}
%   \caption{Securd result using co-observation and reachability constraints.}
% \label{fig:ReachabilitySimulation}
% \end{center}  
% \end{figure}

% \begin{figure}[htbp]
% \centering
% %\subfloat[Unsecured optimal trajectory\label{fig:SecurityBreak}]{\includegraphics[width=0.47\linewidth, trim =1cm 2cm 1cm 2cm, clip]{SecurityBreak}}
% \subfloat[Secured trajectory\label{fig:ReachabilitySimulation}]{\includegraphics[width=0.6\linewidth]{FinalResult}}

% \caption{ is the securd result with co-observation and reachability constraints.}
% \label{fig:2_ADMM_result}
% \end{figure}

\subsubsection{Limitations}\label{sec:reachability-discussion}
Our solution demonstrates the potential of planning with reachability and co-observation to enhance the security of multi-agent systems.{\news However, two primary challenges need to be addressed. Firstly, achieving a co-observation and reachability-secured plan is not always feasible, particularly when obstacles or restricted regions separate the robots, preventing them from establishing co-observation schedules or finding reachability-secured paths. For example, agent 3 in~\cref{fig:ReachabilitySimulation} requires additional security measures to create secured reachability areas. Secondly, security requirements can impact overall system performance, as illustrated by the comparison between~\cref{fig:SecurityBreak} and \cref{fig:ReachabilitySimulation}. The introduction of security constraints resulted in the top left corner remaining unexplored by any robots. This trade-off between security and system performance is particularly significant as system performance is a key factor in the decision of multi-agent system deployments. These challenges are further addressed in \cref{sec:cross-trajectory}, ensuring the effective integration of reachability and co-observation in securing multi-agent systems.}

%Our solution shows that planning with reachability and co-observation is a promising approach to enhance the security of multi-agent systems. However, two main challenges have been identified in \cite{wardega2023hola}. Firstly, finding a co-observation and reachability secured plan may not always be feasible when robots are separated from others by obstacles or forbidden regions, or are located far away from each other. In such case, it is impossible for other robots to get close enough to establish co-observation schedules or find a reachability-secured path. Agent 3 in the Figure \ref{fig:ReachabilitySimulation} is a good example, as it required additional security checkpoint to create secured reachability areas. Secondly, security requirements may come at the cost of overall system performance, as illustrated by the comparison of Figure \ref{fig:SecurityBreak} and \ref{fig:ReachabilitySimulation} where, after the introduction of security constraints, the top left corner is never explored by any robots. This is particularly concerning given that system performance is a key factor in the decision to use multi-agent systems. These challenges are addressed in Chapter \ref{sec:cross-trajectory}, in order to ensure the effectiveness of planning with reachability and co-observation in securing multi-agent systems.

\section{Cross-trajectory co-observation planning}\label{sec:cross-trajectory}
To address the feasibility and performance trade-offs, we propose to form \emph{sub-teams} on each route, and setup additional co-observations both within the sub-team and across different sub-teams. These \emph{cross-trajectory co-observations} allow sub-teams to obtain trajectories that are closer to the optimal (as shown in \cref{fig:cross-traj-comparison-set}), because they do not require the entire \emph{sub-team} to meet with other teams for co-observations, thus providing more flexibility.
\subsection{Problem overview}
We start with an unsecured MRS trajectory with $n_p$ routes $\{q_p\}_{p=1}^{N_p}$ (the ADMM-based planner in \cref{sec:ADMM-planning} without security constraints is used, but other planners are applicable). Here, the state $q_p(t), p \in\{\cI_0,\ldots,\cI_{p}\}$ represents the reference position of the $p$-th sub-team at time $t\in\{0, \dots, T\}$. Introducing redundant robots into the MRS, we assume a total of $n > n_p$ robots are available and organized into \emph{sub-teams} through a time-varying partition $\cI(t)=\union_p \cI_p(t)$ where robots in each \emph{sub-team} $\cI_p$ share the same nominal trajectory. To ensure the fulfillment of essential tasks, at least one robot is assigned to adhere to the reference trajectory. The remaining redundant $n_p-n$ robots are strategically utilized to enhance security. These robots focus on co-observations either within their respective sub-teams, or when necessary, deviate and join another sub-team to provide necessary co-observations. The objective of this problem is to formulate a strategy for this new co-observation strategy, named \emph{cross-trajectory co-observation} that the resulting MRS plan meet the security in \cref{rmk:revised-security} while minimizing the number of additional robots required. 

{\news %\zyang{this version right?} To avoid confusion, \zyanghl{Can i do this? since qp is a matrix}{let $q_{p}(t)\in \real{m}$ denotes the reference waypoint for sub-team $p$ at time $t$.} 
Our strategy is based on the following concept:
\begin{definition}
The $i$-th \emph{checkpoint} $v_{pi}=(q_{p},t_{i})$ for sub-team $p$ is defined as a location $q_{pi}=q_{p}(t_i)$ and time $t_{i}$ at which a robot is co-observed by its teammates, and where it can leave or join a new team.
\end{definition}
For simplicity, let $\cI_{v_{i}}$ denote the sub-team to which $v_{i}$ belongs. %, and $q_{v_{pi}} =q_{pi}$ and $t_{v_{pi}}$ be the corresponding location and time for checkpoint $v_{pi}$.
To ensure the security of the reference trajectory, the reachability region between consecutive checkpoints must avoid intersections with forbidden regions. This requirement can be formally stated as:
\begin{remark}
  A set of checkpoints $V_{p}=\{ v_{p0}, \dots ,v_{pT}\}$ (arranged in ascending order of $t_{v_{pi}}$) can secure the reference trajectory for sub-team $p$, if $\mathcal{E}(q_{v_{pi}}, q_{v_{p(i+1)}}, t_{v_{pi}},t_{v_{p(i+1)}}) \intersect F = \emptyset$ for every $i$, where $F$ is the union of all forbidden regions.
  \end{remark}
}
{\news \zyang{Any better ways since $V_c, E$ are all introduced later?, also will $V_p$ and $V_q$ cause confusion?} 
% The planned trajectory $\{q_p\}_{p=1}^{N_p}$ is illustrated as a directed \emph{checkpoint graph} $G{q}=(V_{q}, E_{q})$, where $V_{q} = V_p \union V_c$ are union of checkpoints $V_p$ and connection verticies $V_c$, $E_{q} = E_{t} \union E_{c}$ are union of trajectory edges $E_t$ and connection edges $E_c$ (introduced later in \cref{sec:cross-trajectory}). Inspired by~\cite{yu2013multi}, additional robots in the sub-team are treated as flows in the checkpoint graph. This transforms the co-observation planning problem into a network multi-flow problem, solvable with general Mixed-Integer Linear Programming techniques.
The planned trajectory $\{q_p\}_{p=1}^{N_p}$ is represented as a directed \emph{checkpoint graph} $G=(V, E)$, where verticies $V = (\union_p V_p) \union V_c$ are a subset of waypoints on the planned trajectory, and edges $E_{q} = E_{t} \union E_{c}$ represents feasible paths connecting $V_q$. Specifically,
\begin{description}
  \item[$V_p$]: Checkpoints where additional robots are required for security through co-observation.
  \item[$E_t$]: Trajectory edges representing the original planned path of the primary robot.
  \item[$E_c$]: Cross-trajectory edges with at least one endpoint as a checkpoint, representing feasible paths where robots deviate from the original trajectory to join other teams or provide co-observation support.
  \item[$V_c$]: Connection vertices representing non-checkpoint locations linked via $E_c$.
\end{description}

The co-observation planning problem is transformed into a network multi-flow problem where the additional robots treated as flows traveling through $G$. To satisfy security requirements, every checkpoint $V$ must be visited by at least one flow.This formulation reduces the co-observation problem to finding valid flow patterns in $G$, enabling the use of Mixed-Integer Linear Programming (MILP) techniques to efficiently compute feasible solutions.
}

This section presents the two components of our approach: constructing the checkpoint graph based on unsecured multi-robot trajectories, and the formulation and solution of the network multi-flow problem.

\subsection{Rapidly-exploring Random Trees}
To find edges between different nominal trajectories, we use the \rrtstar{}~\cite{karaman2010incremental} algorithm to find paths from a waypoint on one trajectory to multiple destination points (i.e., reference trajectories of other sub-teams, in our method). As a optimal path planning algorithm, \rrtstar{} returns the shortest paths between an initial location and points in the free configuration space, organized as a tree. We assume that the generated paths can be travelled in both directions (this is used later in our analysis). 
Key functions from \rrtstar{} that are also used during constructions of the checkpoint graph are \zyang{get back to check which is used}
\begin{description}
\item[$\texttt{Cost}(v)$] This function assigns a non-negative cost (total travel distance in our application) to the unique path from the initial position to $v$ . 
\item[$\texttt{Parent}(v)$] This is a function that maps the vertex $v$ to $v'\in V$ such that $(v',v)\in E$.
\end{description}

Our objective here is to ascertain the existence of feasible paths instead of optimize specific tasks. While the ADMM based solver \Cref{sec:ADMM-planning} presented earlier offers a broader range of constraint handling, RRT*'s efficient exploration of the solution space, coupled with its ability to incorporate obstacle constraints, makes it a fitting choice for building the checkpoint graph.

\subsection{Checkpoint graph construction}\label{sec:security-checkpoint}

In this section, we define and search for security checkpoints and how to use \rrtstar{} to construct the checkpoint graph $G_{q}$.
A heuristic approach is provided to locate the checkpoints on given trajectories (an optimal solution would likely be NP-hard, while the approach below works well enough for our purpose). %with a toy example shown in Figure \ref{fig:checkpoint-generate}. 

{\news We begin by adding the start and end locations $(q_{p}(t_0),t_0)$, $(q_{p}(t_2),t_2)$ to $V_{p}$, with $t_{0}=0$, $t_2=T$ as \emph{start} and \emph{end verticies}. Then, we search for the largest $t_{1} \in \{t_{0}+1, \dots ,t_{2}\}$ such that the reachability ellipsoid between $q_{p}(t_{0})$ and $q_{p}(t_{1})$ has no overlap with any of the forbidden areas, i.e. $\mathcal{E}(q_{p}(t_{0}),q_{p}(t_{1}), t_{0},t_{1})\intersect F = \emptyset$. Then $(q_{p}(t_{1}),t_1)$ is added to $V_{p}$. Simultaneously, we search backward to find $q_{p}(t_{3})$ with the smallest $t_{3}\in \{t_{1},\dots,t_{2}-1\} $ that meets the reachability requirement $\mathcal{E}(q_{p}(t_{2}),q_{p}(t_{3}),t_{2},t_{3}) \intersect F = \emptyset$. Then $(q_{p}(t_{3}),t_3)$ is added to $V_{p}$. Finally, we set $t_{0}\leftarrow t_{1}$, $t_{2}\leftarrow t_{3}$ and repeat the same process. The search is stopped when $\mathcal{E}(q_{p}(t_{0}),q_{p}(t_{2}),t_{0},t_{2}) \intersect F = \emptyset$ or $t_{0}>t_{2}$. A toy example is shown in \cref{fig:checkpoint-generate}. }

\begin{figure}
	\centering
    \subfloat[]{\includegraphics[width=0.45\linewidth,trim = 1.7cm 2cm 1cm 2.7cm, clip,valign=c]{SC_gen_1}}
    \subfloat[]{\includegraphics[width=0.45\linewidth,trim = 1.7cm 2cm 1cm 2.7cm, clip,valign=c]{SC_gen_2}}
    \caption{\news{Checkpoint generation example}}\label{fig:checkpoint-generate}
\end{figure}

% \begin{algorithm}
%   \caption{Secure Checkpoint Generation for a Sub-Team $p$}\label{alg:checkpoint-gen}
%   \begin{algorithmic}
%   \State $v_{p0} \gets (q_{p}(0),0)$; $v_{pT} \gets (q_{p}(T),T)$
%   \State $V_{p} = \{v_{p0}, v_{pT}\}$
%   \State $t_0 \gets 0$; $t_1 \gets T$
%   \While {$\mathcal{E}(q_{p}(t_{0}),q_{p}(t_{1}),t_{0},t_{1}) \intersect F \neq \emptyset$ or $t_1 - t_0 > 1$}
%     \State $i \gets 1$; $j\gets 1$
%     \While{$\mathcal{E}(q_{p}(t_{0}),q_{p}(t_{0}+i),t_{0},t_0+i) \intersect F = \emptyset$ and $t_0+i > t_1$}
%       \State $v_{pf} \gets (q_{p}(t_0+i),t_0+i)$
%       \State $i \gets i+1$
%     \EndWhile
%     \State $V_{p}\gets V_{p}\union v_{pf}$
%     \While{$\mathcal{E}(q_{p}(t_{1}-j),q_{p}(t_{1}),t_{1}-j,t_{1}) \intersect F = \emptyset$ and $t_0+i \geq t_1-j$}
%     \State $v_{pb} \gets (q_{p}(t_1-j),t_1-j)$
%     \State $j \gets j+1$
%     \EndWhile
%     \If {$t_0+i \neq t_1-j$}
%     \State $V_{p}\gets V_{p}\union v_{pb}$
%     \EndIf
%   \EndWhile
%   \end{algorithmic}
%   \rtron{It is probably better to substitute this with a description in words. If you want to keep the pseudocode, move it to the appendix.}
%   \end{algorithm}

% \begin{figure}
% 	\centering
%     \subfloat[]{\includegraphics[width=0.45\linewidth]{SC_gen_1}}
%     \subfloat[]{\includegraphics[width=0.45\linewidth]{SC_gen_2}}
%     \caption{Checkpoint generation example}\label{fig:checkpoint-generate}
% \end{figure}

\subsubsection{Cross-trajectory edges}\label{sec:cross-traj-edges}
To enable co-observation cross different sub-team at checkpoints, we search for available connection paths (\emph{cross-trajectory edges}) between checkpoints on different trajectories, allowing robots deviate from one sub-team to perform co-observation with a different sub-team. 
%\begin{remark}

Cross-trajectory edges $E_c = (v_1, v_2)$ define viable paths between two reference trajectories, where $\cI_{v_1}\neq\cI_{v_2}$ and at least one of $v_1 $ and $v_2$ correspond to a security checkpoint $\union_p V_p$. The cross-trajectory edges must also adhere to reachability constraints $\mathcal{E}(q_{v_1}, q_{v_2}, t_{v_1},t_{v_2}) \intersect F = \emptyset$ to ensure that no deviations into forbidden regions can occur during trajectory switches.  
%\end{remark}

\begin{figure}[htbp]
    \centering
  \subfloat[Cross-trajectory edge generation\label{fig:two-edges}]{\includegraphics[width=0.45\linewidth,trim = 0cm 0cm 0cm 0cm, clip, valign=c]{two_edges}}
  \subfloat[Full checkpoint graph\label{fig:security-graph-generate}]{\includegraphics[width=0.45\linewidth,trim = 0cm 0cm 0cm 0.2cm, clip, valign=c]{security_graph}}
  \caption{{\news (\ref{fig:two-edges}) Latest departure node $q^{d}_{b}$ found for $v_{r1}$ and earliest arrival node $q^{a}_{b}$ found for $v_{r3}$. (\ref{fig:security-graph-generate}) A full checkpoint graph, where circles are checkpoints $V_p$, triangles are connection nodes $V_c$, colored arrows (red and blue) are trajectory edges $E_t$ and black arrows are cross-trajectory edges $E_c$. Virtual source $v^{+}$ and sink $v^{-}$ are added to be used later in planning problem.}}  
\end{figure}

%We first find trees of feasible paths between each security checkpoint and all other trajectories using position information alone through \rrtstar{} (ignoring, for the moment, any timing constraint). Then, we prune these trees by considering time constraints (that consider the time needed to physically travel from one trajectory to the other while meeting other robots at the two endpoints) and ellipsoidal reachability constraints.

We first find trees of feasible paths between each security checkpoint and all other trajectories using position information alone (ignoring, for the moment, any timing constraint). 
More precisely, \new{for each checkpoint $v_p \in \union_p V_p$, we use \rrtstar~ to find all feasible, quasi-optimal paths from $q_{v_p}(t_{v_p})$ to all the waypoints $\{q_{r}(t_{{r}_{i}})\}$ on reference trajectories of all other sub-teams $\cI_{r} = \cI \setminus \cI_{p}$.}
Then, to prune these trees, we consider the time needed to physically travel from one trajectory to the other while meeting other robots at the two endpoints. This is done by calculating the minimal travel time $t_{\textrm{path}}=\texttt{Cost}(q)/v_{max}$ for a robot to traverse each path. Two types of connecting nodes can be found.

\begin{description}
\item[Arrival nodes] are waypoints on $\{q_r\}$ where robots from sub-team $\cI_p$, deviating at $v_p$, can meet with sub-team $\cI_r$ at $(q_r(t_{r_i}),t_{r_i})$. For these, \rrtstar{} must have found a path from $v_p$ to $q_{r}(t^{a}_r)$ with $t_{p}+t_{\textrm{path}}<t_{{r}_{i}}$, and $\mathcal{E}(q_{r}(t_{{r}_{i}}),q_{p},t_{{r}_{i}},t_{p}) \intersect F = \emptyset$.

For each trajectory $r\neq p$, we define the \emph{earliest arrival node} from $v_p$ to $v_{ea} = (q_{r}(t^{a}_r),t^{a}_r)$ as the arrival node characterized by the minimum $t^{a}_r$ discovered. 
%$t^{a}_r$ is designated as the \emph{earliest arrival time}.

\item[Departure nodes] are the waypoints on $\{q_r\}$ such that a robot from sub-team $\cI_r$, deviating from $(q_{r}(t_{{r}_{i}}),t_{{r}_{i}})$, can meet with robots in sub-team $\cI_p$ at $v_{p}$. For these nodes, \rrtstar{} must find a path from $v_p$ to $q_{r}(t_{{r}_{i}})$ for $v_p$ if  $t_{p}>t_{{r}_{i}}+t_{\textrm{path}}$ and $\mathcal{E}(q_{p}, q_{r}(t_{{r}_{i}}),t_{p}, t_{{r}_{i}}) \intersect F = \emptyset$. 

For each trajectory $r\neq p$, we define the \emph{latest departure node} $v_{ld}=(q_{r}(t^{d}_r),t^{d}_r)$ as the departure node characterized by the maximum $t^{d}_r$ discovered.
% $t^{d}_r$ is designated as the \emph{latest departure time}.
\end{description}
% For each $v_{p} \in V_{p}$, all the latest departure and earliest arrival nodes are added as vertices $V_q = V_{p} \union \{v_{ea}, v_{ld}\}$, and the corresponding paths are added as cross-trajectory edges to $E_{q}$. Examples are shown in \cref{fig:two-edges}.
{\news $V_c$ is the collection of all the latest departure and earliest arrival nodes (if they are not identified as checkpoints already), and the corresponding paths are added as cross-trajectory edges $E_q$. A toy example is shown in \cref{fig:two-edges}.}

\subsubsection{In-trajectory edges}\label{sec:Graph-intro}

%With vertices $V_{q}$ and cross-trajectory edges $E_{q}$ found in Algorithm \ref{alg:cross-trajectory-edges}, we can construct a security graph $G_{q}$. 
\new{Let $V =\{ v^i_p,\dots\}_{p=1}^{N_p}$ represent the set of all vertices found in~\cref{sec:security-checkpoint,sec:cross-traj-edges}. We group these verticies by sub-teams and arrange them in ascending order of their timestamps $t_{v^i_{p}}$. For each sub-team, consecutive vertices $v^i_{p}$ and $v^{i+1}_{p}$ are connected by adding \emph{in-trajectory edges} $\{(v^i_{p}\rightarrow v^{i+1}_{p})\}$ to $E_q$, representing corresponding segment of the planned trajectory. Examples are shown in \cref{fig:security-graph-generate}. }

%For convenience, we use $|V_{q}|$ and $|E_{q}|$ to denote the cardinality of the sets $V_{q}$ and $E_{q}$ 

\subsection{Co-observation planning problem}
In this section, we formulate the cross-trajectory planning problem as a network multi-flow problem, and solve it using mixed-integer linear programs (MILP). We assume that $n_p$ robots are dedicated (one in each sub-team) to follow the reference trajectory (named \emph{reference robots}). The goal is to plan the routes of the $n-n_p$ additional \emph{cross-trajectory robots} dedicated to cross-trajectory co-observations, and potentially minimize the number of cross-trajectory robots needed. 

\begin{remark}
Note that we assign fixed roles to robots for convenience in explaining the multi-flow formulation. In practice, after a cross-trajectory robot joins a team, it is considered interchangable, and could switch roles with the reference robot of that trajectory. % (i.e., the original reference robot might serve as a cross-trajectory robot in a later cross-trajectory co-observation).
\end{remark}

{\news To formulate the problem as a network multi-flow problem, we augment the checkpoint graph to a flow graph. A \emph{virtual source} node $v^{+}$ and a \emph{virtual source} node is added to the vertices $V= (\union_p V_p) \union V_c \union \{v^{+},v^{-}\}$. Additional directed edges from $v^{+}$ to all the start vertices, and from all end vertices to $v^{-}$ are added $E = E_{q} \union \{(v_{+},v^{0}_{p})\}_{p} \union \{( v^{T}_{p},v_{-})\}_{p}$ with $v^0_p$ and $v^T_p$ representing the start and end vertices of sub-team $\cI_p$ (dashed arrows in~\cref{fig:example-cross-traj}).}

%The goal is to find paths in $G$ for all the cross-trajectory robots that starts from the virtual source $v^{+}$ and ends in the virtual sink $v^{-}$.
The path of a robot $k$ all starts from $v^{+}$ and ends at $v^{-}$, and are represented as a flow vector $\vf^{k} = \{ f^{k}_{ij} \}$, where $f^{k}_{ij} \in \{1,0\}$ is an indicator variable representing whether robot $k$'s path contains the edge $v_{i}\to v_{j}$. The planning problem can be formulated as a path cover problem on $G_{q}$, i.e., as finding a set of paths $F=[\vf_{1},\dots, \vf_{\cK}]$ for cross-trajectory robots such that every checkpoint in $\union_p V_{p}$ is included in at least one path in $F$ (to ensure co-observation at every checkpoint as required by \Cref{rmk:revised-security}). %Additionally, to encourage the robots' exchange between different sub-teams, cross-trajectory co-observations should be preferred compared to co-observation within the same team. 

Technically, we can always create a trivial schedule that involves only co-observations between members of the same team; this, however, would make the solution more vulnerable in the case where multiple agents are compromised in the same team. While in this paper we explicitly consider only the single attacker scenario, multi-attacks can be potentially handled by taking advantage of the \emph{decentralized blocklist protocol} introduced in \cite{wardega2023byzantine}. For this reason, we setup the methods presented below to always prefer \emph{cross-trajectory co-observation} when feasible.

Finally, edges from the virtual source and to the virtual sink should have zero cost, to allow robots to automatically get assigned to the starting point that is most convenient for the overall solution (lower cost when taking cross-trajectory edges).
These requirements are achieved with the weights for edges $(v_{i},v_{j})\in E$ defined as:
\begin{equation}
	w_{i,j}=\begin{cases}
	-w_{t} & \cI_{v_{i}}=\cI_{v_{j}}, (v_{i},v_{j})\in E_{q}\\
	w_{c} & \cI_{v_{i}} \neq \cI_{v_{j}}, (v_{i},v_{j})\in E_{q}\\
	0 &  (v_{i},v_{j})\in E / E_{q} 
	\end{cases}
\end{equation}
where $w_{c} > w_{t}$. 

With the formulation, the planning problem is written as an optimization problem, where the optimization cost balances between the co-observation performance and total number of flows (cross-trajectory robots) needed:
 \begin{subequations} \label{eq:flow-coverage-problem}
     \begin{align}
        \min_{F} &\sum^{\cK}_{k} \sum_{(+i)\in E} f^{k}_{+i} - \rho \sum^{\cK}_k \sum_{(ij)\in E} w_{ij} f^k_{ij} \label{eq:flow-cost}\\
        s.t. & \sum_{\{h:(hi) \in E\}}f^k_{hi}=\sum_{\{j:(ij) \in E\}}f^k_{ij},  \forall k,\forall v \in V_{q} / \{v^{+}, v^{-}\}  \label{eq:FlowBalanceConstraint}\\
        & \sum^{\cK}_k\sum_{\{i:(ij)\in E \}} f^k_{ij} \geq 1, \forall v_{j} \in \{V^{s}_{p}\} \label{eq:FlowCoverage}\\
        & f^k_{ij} \in \{0,1\} \,  \forall (ij)\in E\label{eq:SingleFLowCapacity}
     \end{align}
 \end{subequations}
where, for convenience, we used $(ij)$ to represent the edge $(v_{i},v_{j})$, and $(+i)$ to represent the edge $(v^{+},v_{i})$.

The first term in the cost \eqref{eq:flow-cost} represents the total number of robot used, and the second term represents the overall co-observation performance (defined as the total number of cross-trajectory edges taken by all flows beyond the regular trajectory edges); the constant $\rho$ is a manually selected penalty parameter to balance between the two terms. \eqref{eq:FlowBalanceConstraint} is the flow conservation constraint to ensures that the amount of flow entering and leaving a given node $v$ is equal (except for $v^{+}$ and $v^{-}$). \eqref{eq:FlowCoverage} is the flow coverage constraints to ensures that all security checkpoints $ \{V^{s}_{p}\}$ have been visited co-observed. The security graph $G_{q}$ is acyclic, making this problem in complexity class $P$, thus, can be solved in polynominal time \cite{1702662}. 

\subsection{Co-observation performance}
Notice that problem \eqref{eq:flow-coverage-problem} is guaranteed to have a solution for $\cK=N_{p}$ where all $\cK$ robots follows the reference trajectory ($f^{k}_{ij}=1, \forall \cI_{v_{i}}=\cI_{v_{j}}=k$).  %Additionally, for a fixed number of robots $\cK \geq N_{p}$, 
It is possible for the resulting flows to have a subset of flows $F_{e} \in F$ that is empty, i.e. $f_{ij}=0, \forall (v_{i},v_{j})\in E$, $f\in F_{e}$; these flow will not increase the cost and can be discarded from the solution.  

The constant $\rho$ selects the trade-off between the number of surveillance robots and security performance. An increase in robots generally enhancing security via cross-trajectory co-observations; this also increases the complexity of the coordination across robots. In order to identify the minimum number of robots necessary, we propose an iterative approach where we start with $\cK=1$ and gradually increases it until $F$ contains an empty flow, indicating the point where further robot additions do not improve performance. 

\begin{remark} 
The value of row $\rho$ is upper bounded such that the second term for each single flow in \eqref{eq:flow-cost} is always smaller than one, i.e., $ \rho \sum_{(ij)\in E} w_{ij} f^k_{ij}\leq 1$. Otherwise, the iteration continues indefinitely as adding additional flow introduce a negative term $\sum_{(+i)\in E} f^{k}_{+i} - \rho\sum_{(ij)\in E} w_{ij} f^k_{ij} = 1- \rho\sum_{(ij)\in E} w_{ij} f^k_{ij}<0$ which always makes the cost \eqref{eq:flow-cost} smaller.
\end{remark}

\subsection{Result and simulation}

\begin{figure}
  \centering
  \subfloat[Cross-trajectory co-observation plan \label{fig:previous_result_plan}]{\includegraphics[width=0.47\linewidth, trim = 4cm 2cm 4cm 2cm,valign=c]{old_result}}
  \subfloat[Checkpoint graph and result flows \label{fig:previous_result_graph}]{\includegraphics[width=0.47\linewidth, trim = 4cm 1cm 4cm 1cm,valign=c]{old_result_graph.png}}
  \caption{\Cref{fig:previous_result_plan} showcase an unsecured 4-robot map exploration task. The cross-trajectory co-observation plan is shown as dotted arrows on top of the original plan in \Cref{fig:previous_result_plan}. The checkpoint graph and resulting flows are shown in \Cref{fig:previous_result_graph}.}
  \label{fig:3-team-ctco}
\end{figure}

We first test the proposed method for the example application in \Cref{fig:example-application,fig:ReachabilitySimulation}, using the same setup in \Cref{sec:ADMM-simulation}. Using the parameters $w_{c}=10$, $w_{t}=1$ and $\rho = 0.01$, the result returns a total of $\cK=3$ surveillance robots with cross-trajectory plan shown in \Cref{fig:3-team-ctco}. %In \Cref{fig:previous_result_grap}, each horizontal line represents the original trajectory of a sub-team and the number on each vertex $v_{i}$ represents the corresponding time $t_{i}$. 
The flows derived from the solution of the optimization problem \eqref{eq:flow-coverage-problem} are highlighted in the graph \Cref{fig:previous_result_graph}, where each horizontal line represents the original trajectory of a sub-team and the number on each vertex $v_{i}$ represents the corresponding time $t_{i}$. The planning result in the workspace is shown in \Cref{fig:previous_result_plan} as dash-dotted arrows with the same color used for each flow in \Cref{fig:previous_result_graph}. Compared with the result in \Cref{fig:ReachabilitySimulation}, it is easy to see that there is a significant improvement in map coverage in \Cref{fig:previous_result_plan}. At the same time, unsecured deviations to the forbidden regions of robots are secured through cross-trajectory observations. 

The problem shows no solution for $\cK\leq 2$. For cases $\cK=3$, problem return the optimal result as shown in \Cref{fig:Cross-trajectory-result}. If we further increase $\cK>3$, we do not get a better result; instead, the planner will return four flows with the rest $\cK-3$ flows empty. 

We then test the proposed method for a 4-team and 7-team case with result shown in \cref{fig:Cross-trajectory-result}, where four trajectories are provided for a map exploration task with no security related constraints (co-observation schedule and reachability). We have a $10m\times10m$ task space, three forbidden regions (rectangle regions in \Cref{fig:Result-plan}) and robots with a max velocity of $0.5m/dt$. 

\begin{figure}
  \centering
  %\subfloat[Unsecured plan\label{fig:unsecured-plan}]{\includegraphics[width=0.31\linewidth, trim = 3cm 2cm 3cm 2cm, clip,valign=c]{SecurityBreak}}
  \subfloat[4-agent co-observation plan\label{fig:Result-plan}]{\includegraphics[width=0.47\linewidth,trim = 4cm 2cm 4cm 2cm, clip,valign=c]{Traj_result}}
  %\subfloat[Graph flow result\label{fig:result-graph}]{\includegraphics[width=0.47\linewidth,trim = 4cm 0cm 4cm 0cm, clip,valign=c]{Graph_result}}
  \subfloat[7-agent co-observation plan\label{fig:Result-plan-7-team}]{\includegraphics[width=0.47\linewidth,trim = 4cm 2cm 4cm 2cm, clip,valign=c]{7-team-plan.png}}
  %\subfloat[Graph flow result\label{fig:result-graph-7-team}]{\includegraphics[width=0.47\linewidth,trim = 4cm 0cm 4cm 0cm, clip,valign=c]{7-team-graph.png}}
  \caption{Cross-trajectory co-observation result of a 4 sub-teams task (\Cref{fig:Result-plan}) and a 7 sub-teams task \Cref{fig:Result-plan-7-team}}\label{fig:Cross-trajectory-result}
\end{figure}

% \begin{figure}
%   \centering
%    \subfloat[Cross-trajectory co-observation plan\label{fig:Result-plan-7-team}]{\includegraphics[width=0.47\linewidth,trim = 4cm 2cm 4cm 2cm, clip,valign=c]{7-team-plan.png}}
%   \subfloat[Graph flow result\label{fig:result-graph-7-team}]{\includegraphics[width=0.47\linewidth,trim = 4cm 0cm 4cm 0cm, clip,valign=c]{7-team-graph.png}}
%   \caption{Cross-trajectory co-observation result of a 7 sub-teams task.}\label{fig:Cross-trajectory-result-7}
% \end{figure}

\section{Summary}\label{sec:summary}

This paper introduces security measures for protecting Multi-Robot Systems (MRS) from plan-deviation attacks. We establish a mutual observation schedule to ensure that any deviations into forbidden regions break the schedule, triggering detection. Co-observation requirements and reachability analysis are incorporated into the trajectory planning phase, formulated as constraints for the optimal problem. In scenarios where a secured plan is infeasible or enhanced task performance is necessary, we propose using redundant robots for cross-trajectory co-observations, offering the same security guarantees against plan-deviation attacks. However, the time-sensitive and proximity-dependent nature of co-observation necessitates a focus on collision avoidance during planning. Future work will integrate collision avoidance and explore dynamic duty assignments within sub-teams, increasing the challenge for potential attackers.

%This paper introduces security measures to protect Multi-Robot Systems (MRS) from plan-deviation attacks by setting up mutual obversation schedule to guarangee that any deviations into forbidden regions will break the schedule and trigger detection. We incorporate the co-observation requirements and reachability analysis into the trajectory planning phase and formulate them as constraints for the optimal problem. In scenarios where a secured plan is infeasible or better task performance is needed, we propose the use of redundant robots for cross-trajectory co-observations, providing the same security guarantees against plan-deviation attacks. However, given the time-sensitive nature of co-observation and the need for close proximity, collision avoidance during co-observation planning becomes crucial. Future work will focus on integrating collision avoidance into the planning phase. Additionally, dynamic assignment of duties within sub-teams will be explored, making it more challenging for attackers to plan and execute successful attacks. 

%In this paper, we provide methods to enhance the security of a MRS against plan-deviation attacks. First, by introducing co-observation schedule and keeping reachability region during unobserved periods away from the forbidden regions, we provide an secured trajectory optimized for certain scenarios with guarantees that any deviations to forbidden regions will for sure break the schedule and get detected. Additionally, for scenarios that requires better task performance or when a secured plan is not feasible, we introduce redundant robots to performs cross-trajectory co-observations that can provide any unsecured MRS trajectories with the same security guarantee.

%As co-observation is time-sensitive and requires robots to be in close proximity, it is important to consider the possible collision during co-observation planning. The main future work will focus on including collision avoidance in the planning phase. Additionally, the assignment of the duties within the sub-team can performed dynamically, making it more difficult for attackers to successfully plan and execute attacks. This makes realtime task assignment and control another topic worth looking into.

\appendix
{\news
\subsection{Transformation of reachability ellipsoid to canonical frame}\label{apx:transformation}
The ellipse $\cE$ expressed in $\cF_\cE$ is given by $\Eframe{\cE}=\{\Eframe{q}\in\real{m}:d(q^\cE_1,\Eframe{q})+d(\Eframe{q},q^\cE_2)<2a\}$, with foci $q^\cE_1,q^\cE_2$ in $\cF_\cE$ defined as
$q^\cE_1=\bmat{c & 0 & 0}\transpose, q^\cE_2=\bmat{-c & 0 & 0}\transpose$, and semi-axis distance $c=\frac{\norm{q_2-q_1}}{2}$.
\begin{definition}
  The \emph{reachability ellipsoid $\cE$ in the canonical frame} is defined as as the zero level set of the quadratic function
  \begin{equation}\label{equ:standard-ellipse}
    \Eframe{E}(\Eframe{q}) = \Eframe{q}\transpose Q \Eframe{q} - 1
  \end{equation}
  where
  \begin{equation}
    Q = \diag(a^{-2},b^{-2},b^{-2}),
  \end{equation}
  and $b = \sqrt{a^2-c^2}$.
  The ellipse parameters $a$, $b$ represent the lengths of the major axes.
\end{definition}
\begin{lemma}
The original ellipse $\cE$ in $\cF$ can be expressed as the zero level set of the quadratic function
   \begin{equation}\label{eq:ellpsoid from canonical}
     \Fframe{E}(q) = (q-o_\cE)\transpose H\transpose Q H (q-o_\cE) - 1
     \end{equation}
\end{lemma}
\begin{proof}
    The claim follows by substituting  \eqref{eq:transformations} into \eqref{equ:standard-ellipse}, and from the definition of $R$ and $o$.
\end{proof}
\subsection{Householder rotations}\label{sec:householder}
\new{We define a differentiable transformation to a canonical ellipse that is used in the derivation of the reachability constraints in \Cref{sec:reachability,sec:ellipse-region-constraint}. This transformation includes a rotation derived from a modified version of Householder transformations \cite{householder1958unitary}. 
% With respect to the standard definition, our modification ensures that the final operator is a proper rotation (i.e., not a reflection). 
We call our version of the operator a \emph{Householder rotation}. In this section we derive Householder rotations and their differentials for the 3-D case; the 2-D case can be easily obtained by embedding it in the $z=0$ plane.}
\begin{definition} Let $\nu_1$ and $\nu_2$ be two unitary vectors ($\norm{\nu_1}=\norm{\nu_2}=1$). Define the normalized vector $u = \frac{\nu_1+\nu_2}{\norm{\nu_1+\nu_2}}$,
  % \begin{equation}
  %   u=\nu_1+\nu_2,\quad u =\frac{u'}{\norm{u'}}.
  % \end{equation}
the \emph{Householder rotation} $H(\nu_1,\nu_2)$ is defined as
  \begin{equation}\label{eq:H definition}
    H(\nu_1,\nu_2) = 2 u u\transpose-I.
  \end{equation}
\end{definition}
Here $H$ is a rotation mapping $\nu_1$ to $\nu_2$, as shown by the following.
\begin{proposition}\label{prop:HProperty}
  The matrix $H$ has the following properties:
  \begin{enumerate}
  \item It is a rotation, i.e.
    \begin{enumerate}
    \item\label{it:orthonormality} $H\transpose H=I$;
    \item\label{it:determinant} $\det(H)=1$.
    \end{enumerate}
  \item\label{it:transformation} $\nu_2=H \nu_1$.
  \end{enumerate}
\end{proposition}
\begin{proof}
  For subclaim~\ref{it:orthonormality}:
  \begin{equation}
    H\transpose H=H^2=4uu\transpose u u\transpose - 4uu\transpose +I^2=I,
  \end{equation}
  since $u\transpose u=1$.

  For subclaim~\ref{it:determinant}, let $U=\bmat{u & u^\bot_{1} & u^\bot_{2}}$, where $u^\bot_{1},u^\bot_{2}$ are two orthonormal vectors such that $I=UU\transpose=uu\transpose + u^\bot_{1}(u^\bot_{1})\transpose+u^\bot_{2}(u^\bot_{2})\transpose$; then, substituting $I$ in \eqref{eq:H definition}, we have that the eigenvalue decomposition of $H$ is given by
  \begin{equation}
    H=U\diag(1,-1,-1) U\transpose.
  \end{equation}
  Since the determinant of a matrix is equal to the product of the eigenvalues, $\det(H)=1$.

  For subclaim~\ref{it:transformation}, first note that $Hu=2uu\transpose u - u=u$.
  It follows that the sum of $\nu_1$ and $\nu_2$ is invariant under $H$:
  \begin{equation}\label{equ:H(u1+u2)}
    H(\nu_1+\nu_2)=H u \norm{\nu_1+\nu_2}
    = u\norm{\nu_1+\nu_2} =\nu_1+\nu_2,
  \end{equation}
  and that their difference is flipped under $H$:
  \begin{equation}\label{equ:H(u1-u2)}
    H(\nu_1-\nu_2) = 2uu\transpose (\nu_1-\nu_2) - (\nu_1-\nu_2)^2 = -(\nu_1-\nu_2).
  \end{equation}
  Combining (\ref{equ:H(u1+u2)}) and (\ref{equ:H(u1-u2)}) we obtain
  \begin{equation}
    H\nu_1 = \frac{1}{2}\bigl(H(\nu_1+\nu_2)+H(\nu_1-\nu_2)\bigr)
    = \nu_2
  \end{equation}
\end{proof}
We compute the differential of $H$ implicitly using its definition \eqref{equ:dt_to_dx}. We use the notation $\cross{v}:\real{3}\to\real{3\times 3}$ to denote the matrix representation of the cross product with the vector $v$, i.e.,
\begin{equation}
  \bmat{v_1\\v_2\\v_3}_\times= \bmat{0 & -v_3 &v_2\\v_3 & 0 & -v_1\\-v_2 & v_1 & 0},
\end{equation}
such that $[v]_\times w=v\times w$ for any $w\in\real{3}$. %One can verify by direct computation the following property:
%\begin{equation}\label{eq:asymmetric to cross}
%  wv\transpose-vw\transpose=\cross{\cross{v}w}.
%\end{equation}
\begin{proposition}\label{prop:Hderivitive}
  Let $\nu_1(t)$ represent a parametric curve. Then
  \begin{equation}
    \dot{H}=H\cross{-2M\dot{\nu}_{\cF}},
  \end{equation}
  where the matrix $M\in\real{3\times3}$ is given by
  \begin{equation}
    M=[u]_{\times}  \frac{ \left( I - u u\transpose \right) \left( I- \nu_1 \nu_1\transpose \right)} {\norm{u'} \norm{\nu_1}}.
  \end{equation}
\end{proposition}
\begin{proof}
    From the definition of $H$ in \eqref{eq:H definition}, we have
    \begin{equation} \label{equ:H_dot original}
      \dot H =   2(\dot u u\transpose + u \dot u\transpose)
    \end{equation}

    Recall that $\dot{u}=\frac{1}{\norm{u'}}(I-uu\transpose)\dot{u}'$ (see, for instance, \cite{Tron:Arxiv14}), which implies $(I-uu\transpose)\dot{u}'=\dot{u}'$. It follows that $\dot{u}$ flips sign under the action of $H\transpose$:
    \begin{multline}
      H\transpose \dot u = (2u u\transpose-I)\frac{ \left( I - u u\transpose \right) } {\left\|u'\right\|} \dot u' \\
      =\frac{1}{\norm{u'}} (2u u\transpose-I-2u u\transpose u u\transpose+u u\transpose)\dot{u}'\\
      = -\frac{1}{\norm{u'}} (I-u u\transpose)\dot u'
      = -\dot u
    \end{multline}

    Inserting $HH\transpose=I$ in (\ref{equ:H_dot original}), we have
    \begin{equation}
      \begin{split}
        \dot H =  &  2H H\transpose(\dot u u\transpose + u \dot u\transpose)
        =  2 H (-\dot u u\transpose + u \dot u\transpose)\\
        =  &  -2H [[u]_{\times} \dot u]_{\times} \\
        = &  -2 H \left[ [u]_{\times}  \frac{ \left( I - u u\transpose \right) \left( I- \nu_1 \nu_1\transpose \right)} {\left\|u'\right\| \left\|\nu_1\right\|} \dot{\nu}_\cF\right]_{\times}\\
        = & -2 H \cross{M \dot{\nu}_\cF},
      \end{split}
    \end{equation}
    which is equivalent to the claim.
  \end{proof}
}
  \subsection{Proof of proposition \ref{prop:Ellipse2PointDiff}}\label{proof:Ellipse2PointDiff}
      To make the notation more compact, we will use $\partial_q f$ instead of $\partial_{\left[\begin{smallmatrix}q_1\\q_2\end{smallmatrix}\right]} f$ for the remainder of the proof.
    The differential of \eqref{equ:Point2EllipseProjection} can be represented as:
    \begin{equation}\label{equ:dPi_dt}
      \begin{split}
        \dot \pi_{p\cE} = &  \dot H^{-1}SH (q_{avoid} - o)  + H^{-1}\dot S H (q_{avoid} - o) \\
        &+ H^{-1}S \dot H (q_{avoid} - o) + (H^{-1}SH -I)\dot o\\
      \end{split}
    \end{equation}

    where
    \begin{equation}\label{equ:S_dot}
      \begin{split}
        \dot S  =& - S^2 (Q \dot s + s \dot Q)\\
        =& - S^2 (Q \partial_q s \dot q - \partial_b Q \partial_q b \dot q)
      \end{split}
    \end{equation}
    where
    \begin{equation}
      \partial_b Q = 2\frac{s}{b^3} \diag\{0,1,1\}
    \end{equation}
    To compute the derivative $\partial_q \pi$, we need the expression of $\partial_q b$, $\partial_q o$ and $\partial_q s$; the first two can be easily derived using the equations above:
    \begin{align}
      \partial_q b &= \frac{1}{4b}\bmat{q_1-q_2,q_2-q_1}\transpose\\
      \partial_q o &= \bmat{I/2,I/2}\transpose
    \end{align}

    In order to get $\partial_q s$, we use the fact that $F\bigl(s(q)\bigr)=0$ for all $q$; hence $F\bigl(\tilde{q}(t)\bigr)\equiv 0$, and $\partial_q F = 0$. We then have:

    \begin{equation}
      0=\dot F =  2q\transpose Q' \dot q + q\transpose \partial_s Q' q \dot s + q\transpose \partial_bQ' q \dot b
    \end{equation}
    where
    \begin{equation}
      \partial_s Q'= -\diag\left(\frac{2a^2}{(s+a^2)^3},\frac{2b^2}{(s+b^2)^3},\frac{2b^2}{(s+b^2)^3}\right).
    \end{equation}
    By moving term $\dot s$ to the left-hand side we can obtain:
    \begin{multline}\label{equ:s_dot}
      \dot s =  (q\transpose \partial_s Q' q)^{-1} (2q\transpose Q' \dot q + q\transpose \partial_b Q' q \dot b)\\
      =  (q\transpose \partial_s Q' q)^{-1} (-4q\transpose Q' H[U\dot q]_\times (q_{avoid} - o) \\
      -2q\transpose Q'H\dot o + q\transpose \partial_b Q' q \dot b)\\
      =  (q\transpose \partial_s Q' q)^{-1} (-4q\transpose Q' H[q_{avoid} - o]_\times U\dot q \\
      -2q\transpose Q'H\dot o + q\transpose \partial_b Q' q \dot b)
    \end{multline}

    The second term of equation (\ref{equ:dPi_dt}) turns into:
    \begin{multline}
      H^{-1}\dot S H (q_{avoid} - o)
      = - H^{-1} Q' q \dot s - s H^{-1} S^2 \partial_b Q q \dot b\\
      =   \big( (q\transpose \partial_s Q' q)^{-1} H^{-1} Q' q q\transpose  (4Q' H[q_{avoid} - o]_\times U  \\
      + 2Q' H\partial_q o - \partial_b Q' q q \partial_q b) -  s H^{-1} S^2 \partial_b Q q \partial_q b\big) \dot q\\
    \end{multline}

    Thus equation \eqref{equ:dPi_dt} could be written as:
    \begin{multline}
      \dot \pi_{p\cE} = \big(-2 H [ SH(q_{avoid}-o)]_{\times}U   \\
      + \left( (q\transpose \partial_s Q' q)^{-1} H^{-1} Q' q q\transpose  (4Q' H[q_{avoid} - o]_\times U \right. \\
      \left.+ 2Q' H\partial_q o - \partial_b Q' q q \partial_q b) -  s H^{-1} S^2 \partial_b Q q \partial_q b\right) \\
      -2H^{-1} S H[q_{avoid}-o]_{\times} U  \\
      + (H^{-1}SH -I)\partial_q o \big) \dot q,
    \end{multline}
    from which the claim follows.
  
  \subsection{Proof of proposition \ref{prop:dpi_ne_dt}}\label{proof:dpi_ne_dt}
    We first need to derive $\dot{d}_\cE$ and $\dot{d}_{\cE t}$

    \begin{equation}
      \dot d_\cE = -n\transpose \partial_q o \dot q
    \end{equation}
    \begin{equation}\label{equ:dot det}
      \begin{split}
        \dot d_{\cE t} =&  (\dot n_\cE\transpose Q^{-1} n_\cE + n_\cE\transpose \dot Q^{-1} n_\cE + n_\cE\transpose Q^{-1} \dot n_\cE) /\sqrt{n_\cE\transpose Q^{-1} n_\cE}\\
        = & (\sqrt{n_\cE\transpose Q^{-1} n_\cE})^{-1}\left(-2n\transpose H[Q^{-1}n_\cE]_\times U \right.\\
        &\left. + n_\cE \transpose \partial_b Q^{-1} n_\cE \partial_q b  -2 n_\cE Q^{-1}H[n]_\times U \right) \dot q
      \end{split}
    \end{equation}
    Next, we need to derive  $\dot p_{t1}$, $\dot p_{t2} $ and $\dot p_\cL$. Since $p_\cL$ could be written as
    \begin{equation}
      p_\cL = \frac{d_\cE Q^{-1} n_\cE}{ d_{\cE t} ^2},
    \end{equation}
    we have
    \begin{multline}\label{equ:dpl_dt}
        \dot p_\cL =  \left( (-\frac{d_{\cE t} n\transpose \partial_q o -2d_\cE \partial_q d_{\cE t}}{d_{\cE t}^3} )Q^{-1}n_\cE \right.\\
        \left .+ \frac{d_\cE\partial_b Q^{-1} n_\cE \partial_q b -  2d_\cE Q^{-1}H[n]_\times U}{d_{\cE t}^2}\right) \dot q
    \end{multline}
    \begin{multline}\label{equ:dplt_dt}
        \dot p_{1} =  \left(-\frac{Q^{-1}n_\cE \partial_q d_{\cE t} }{d_{\cE t}^2} \right.\\
         \left. + \frac{\partial_b Q^{-1}n_\cE \partial_q b -  2Q^{-1}H[n]_\times U }{d_{\cE t}} \right) \dot q
    \end{multline}
    subtracting $\dot q$ from (\ref{equ:dpl_dt}) and (\ref{equ:dplt_dt}), we can derive the result shown in (\ref{equ:ProjectPoint})


{\small
\bibliographystyle{IEEEtran}
\bibliography{ADMM_planning,ACC,tron,ziqi,reachability}
}

\end{document}
